<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Status App</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- QR Code Generator Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator/qrcode.js"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* bg-gray-900 */
        }
        .animate-spin {
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- Firebase SDKs (ESM version) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-analytics.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            createUserWithEmailAndPassword, 
            signInWithEmailAndPassword, 
            signOut,
            sendPasswordResetEmail,
            deleteUser,
            multiFactor,
            TotpMultiFactorGenerator,
            TotpSecret,
            getMultiFactorResolver
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            setDoc, 
            getDoc, 
            collection, 
            onSnapshot,
            runTransaction,
            updateDoc,
            increment,
            addDoc,
            query,
            where,
            getDocs,
            serverTimestamp,
            writeBatch,
            deleteDoc,
            orderBy
        } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-storage.js";
        import { getDatabase, ref as dbRef, onValue, onDisconnect, set as dbSet, serverTimestamp as rtdbServerTimestamp, remove } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";


        // Make Firebase services available globally for the Babel script
        window.firebaseServices = {
            initializeApp, getAnalytics, getAuth, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            sendPasswordResetEmail, deleteUser, getFirestore, doc, setDoc, getDoc,
            collection, onSnapshot, runTransaction, updateDoc, increment, addDoc,
            query, where, getDocs, serverTimestamp, writeBatch, deleteDoc, orderBy,
            getStorage, ref, uploadBytes, getDownloadURL, getDatabase, dbRef, onValue, onDisconnect, dbSet, rtdbServerTimestamp,
            multiFactor, TotpMultiFactorGenerator, TotpSecret, getMultiFactorResolver, remove
        };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, useRef } = React;
        const {
            initializeApp, getAnalytics, getAuth, onAuthStateChanged, 
            createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut,
            sendPasswordResetEmail, deleteUser, getFirestore, doc, setDoc, getDoc,
            collection, onSnapshot, runTransaction, updateDoc, increment, addDoc,
            query, where, getDocs, serverTimestamp, writeBatch, deleteDoc, orderBy,
            getStorage, ref, uploadBytes, getDownloadURL, getDatabase, dbRef, onValue, onDisconnect, dbSet, rtdbServerTimestamp,
            multiFactor, TotpMultiFactorGenerator, TotpSecret, getMultiFactorResolver, remove
        } = window.firebaseServices;

        // --- MANUELLE FIREBASE KONFIGURATION ---
        const firebaseConfig = {
          apiKey: "AIzaSyBIl7zKRNdhf1wIm7LIAQtF5X1CumEscfQ",
          authDomain: "status-adcc2.firebaseapp.com",
          projectId: "status-adcc2",
          storageBucket: "status-adcc2.appspot.com",
          messagingSenderId: "774008839527",
          appId: "1:774008839527:web:abaa21efce195f80ed23c2",
          databaseURL: "https://status-adcc2-default-rtdb.firebaseio.com"
        };

        const appId = 'status-adcc2';

        // Firebase App initialisieren
        let app;
        let analytics;
        let auth;
        let db;
        let storage;
        let rtdb;
        let firebaseError = null;

        try {
            app = initializeApp(firebaseConfig);
            analytics = getAnalytics(app);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
            rtdb = getDatabase(app);
        } catch (e) {
            console.error("Firebase-Initialisierungsfehler:", e);
            firebaseError = e;
        }
        
        // --- Inline SVG Icons ---
        const Icon = ({ path, className = "w-6 h-6" }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const CrownIcon = () => <Icon path={<><path d="m2 4 3 12h14l3-12-6 7-4-7-4 7-6-7zm3 16h14"/></>} />;
        const UserIcon = () => <Icon path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const ShieldCheckIcon = () => <Icon path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="m9 12 2 2 4-4"/></>} />;
        const LogOutIcon = () => <Icon path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const XIcon = () => <Icon path={<><line x1="18" x2="6" y1="6" y2="18"/><line x1="6" x2="18" y1="6" y2="18"/></>} />;
        const UserXIcon = () => <Icon path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="17" x2="22" y1="8" y2="13"/><line x1="22" x2="17" y1="8" y2="13"/></>} />;
        const KeyRoundIcon = () => <Icon path={<><path d="M2 18v3c0 .6.4 1 1 1h4v-3h3v-3h2l1.4-1.4a6.5 6.5 0 1 0-4-4Z"/><circle cx="16.5" cy="7.5" r=".5"/></>} />;
        const HammerIcon = () => <Icon path={<><path d="m15 12-8.5 8.5c-.83.83-2.17.83-3 0 0 0 0 0 0 0a2.12 2.12 0 0 1 0-3L12 9"/><path d="M17.64 15 22 10.64"/><path d="m20.91 11.7-1.25-1.25c-.6-.6-.93-1.4-.93-2.25v-.86L16.01 4.6a5.56 5.56 0 0 0-3.94-1.64H9l.92.82A6.18 6.18 0 0 1 12 8.4v1.56l2 2h2.47l2.26 1.91"/></>} />;
        const NotebookIcon = () => <Icon path={<><path d="M2 6h4"/><path d="M2 10h4"/><path d="M2 14h4"/><path d="M2 18h4"/><rect width="16" height="20" x="4" y="2" rx="2"/><path d="M16 2v20"/></>} />;
        const CheckCircleIcon = () => <Icon path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const AlertTriangleIcon = () => <Icon path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />;
        const XCircleIcon = () => <Icon path={<><circle cx="12" cy="12" r="10"/><line x1="15" x2="9" y1="9" y2="15"/><line x1="9" x2="15" y1="9" y2="15"/></>} />;
        const InfoIcon = () => <Icon path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="16" y2="12"/><line x1="12" x2="12.01" y1="8" y2="8"/></>} />;
        const EyeOffIcon = () => <Icon path={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>} />;
        const EyeIcon = () => <Icon path={<><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"/><circle cx="12" cy="12" r="3"/></>} />;
        const Loader2Icon = () => <Icon path={<path d="M21 12a9 9 0 1 1-6.219-8.56"/>} className="w-6 h-6 animate-spin"/>;
        const UsersIcon = () => <Icon path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></>} />;
        const PhoneIcon = () => <Icon path={<><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></>} />;
        const PhoneOffIcon = () => <Icon path={<><path d="M10.68 13.31a16 16 0 0 0 3.41 2.6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7 2 2 0 0 1 1.72 2v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91"/><line x1="22" x2="2" y1="2" y2="22"/></>} />;
        const MessageSquareIcon = () => <Icon path={<><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></>} />;
        const UserPlusIcon = () => <Icon path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" x2="19" y1="8" y2="14"/><line x1="22" x2="16" y1="11" y2="11"/></>} />;
        const DownloadIcon = () => <Icon path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const CameraIcon = () => <Icon path={<><path d="M14.5 4h-5L7 7H4a2 2 0 0 0-2 2v9a2 2 0 0 0 2 2h16a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2h-3l-2.5-3z"/><circle cx="12" cy="13" r="3"/></>} />;
        const SettingsIcon = () => <Icon path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 0 2l-.15.08a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.38a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1 0-2l.15-.08a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;


        // --- Hilfskomponenten & UI-Elemente ---
        const Card = ({ children, className = '' }) => (
            <div className={`bg-gray-800 bg-opacity-80 backdrop-blur-sm border border-gray-700 rounded-xl shadow-lg p-6 ${className}`}>
                {children}
            </div>
        );

        const Button = ({ children, onClick, className = '', variant = 'primary', ...props }) => {
            const baseClasses = 'px-4 py-2 rounded-lg font-semibold transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed';
            const variants = {
                primary: 'bg-blue-600 hover:bg-blue-700 text-white focus:ring-blue-500',
                secondary: 'bg-gray-600 hover:bg-gray-700 text-white focus:ring-gray-500',
                danger: 'bg-red-600 hover:bg-red-700 text-white focus:ring-red-500',
                success: 'bg-green-600 hover:bg-green-700 text-white focus:ring-green-500',
            };
            return (
                <button onClick={onClick} className={`${baseClasses} ${variants[variant]} ${className}`} {...props}>
                    {children}
                </button>
            );
        };

        const Input = (props) => (
            <input
                {...props}
                className="w-full px-4 py-2 bg-gray-700 border border-gray-600 rounded-lg text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            />
        );

        const Modal = ({ isOpen, onClose, title, children }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 flex justify-center items-center z-50 p-4">
                    <div className="bg-gray-900 rounded-2xl shadow-2xl w-full max-w-md border border-gray-700">
                        <div className="flex justify-between items-center p-4 border-b border-gray-700">
                            <h2 className="text-xl font-bold text-white">{title}</h2>
                            <button onClick={onClose} className="text-gray-400 hover:text-white">
                                <XIcon />
                            </button>
                        </div>
                        <div className="p-6">{children}</div>
                    </div>
                </div>
            );
        };

        // --- Status-Komponente ---
        const StatusIndicator = ({ status }) => {
            const statusInfo = useMemo(() => {
                switch (status) {
                    case 'operational':
                    case 'none':
                         return { text: 'Alle Systeme operationell', color: 'text-green-400', icon: <CheckCircleIcon /> };
                    case 'degraded_performance':
                    case 'minor':
                         return { text: 'Leistungseinbußen', color: 'text-yellow-400', icon: <AlertTriangleIcon /> };
                    case 'partial_outage': return { text: 'Teilweiser Ausfall', color: 'text-orange-400', icon: <AlertTriangleIcon /> };
                    case 'major_outage': 
                    case 'major':
                        return { text: 'Schwerer Ausfall', color: 'text-red-500', icon: <XCircleIcon /> };
                    case 'critical':
                        return { text: 'Kritischer Ausfall', color: 'text-red-700', icon: <XCircleIcon /> };
                    default: return { text: status.replace(/_/g, ' '), color: 'text-gray-400', icon: <InfoIcon /> };
                }
            }, [status]);

            return (
                <div className={`flex items-center gap-2 ${statusInfo.color}`}>
                    {statusInfo.icon}
                    <span className="font-semibold">{statusInfo.text}</span>
                </div>
            );
        };

        const FortniteStatus = () => {
             const [statusData, setStatusData] = useState(null);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);

            useEffect(() => {
                const fetchStatus = async () => {
                    try {
                        setLoading(true);
                        setError(null);
                        const response = await fetch('https://status.epicgames.com/api/v2/status.json');
                        if (!response.ok) throw new Error(`HTTP-Fehler! Status: ${response.status}`);
                        const data = await response.json();
                        
                        if (data && data.status) {
                            setStatusData(data.status);
                        } else {
                            console.error("Unerwartete API-Antwort:", data);
                            throw new Error('Unerwartete API-Antwortstruktur.');
                        }
                    } catch (e) {
                        setError(e.message || 'Status konnte nicht geladen werden.');
                        console.error(e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchStatus();
                const interval = setInterval(fetchStatus, 300000);
                return () => clearInterval(interval);
            }, []);

            return (
                <Card>
                    <h2 className="text-2xl font-bold text-white mb-4">Epic Games-Dienststatus</h2>
                    {loading && <p className="text-gray-300">Lade Status...</p>}
                    {error && <p className="text-red-400">{error}</p>}
                    {statusData && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center">
                                <span className="text-lg text-gray-200">{statusData.description}</span>
                                <StatusIndicator status={statusData.indicator} />
                            </div>
                        </div>
                    )}
                </Card>
            );
        };

        // --- Authentifizierungs-Komponente ---
        const AuthModal = ({ isOpen, onClose }) => {
             const [view, setView] = useState('login');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [username, setUsername] = useState('');
            const [error, setError] = useState('');
            const [successMessage, setSuccessMessage] = useState('');
            const [loading, setLoading] = useState(false);
            const [showPassword, setShowPassword] = useState(false);
            const [mfaResolver, setMfaResolver] = useState(null);
            const [verificationCode, setVerificationCode] = useState('');

            const resetForm = (newView = 'login') => {
                if (newView !== 'completeRegistration') setEmail('');
                setPassword('');
                setUsername('');
                setError('');
                setSuccessMessage('');
                setView(newView);
                setMfaResolver(null);
                setVerificationCode('');
            };
            
            const handleClose = () => {
                resetForm('login');
                onClose();
            };

            const handlePasswordReset = async (e) => {
                e.preventDefault();
                setError(''); setSuccessMessage(''); setLoading(true);
                try {
                    await sendPasswordResetEmail(auth, email);
                    setSuccessMessage("E-Mail zum Zurücksetzen des Passworts wurde gesendet.");
                } catch (err) {
                    setError("E-Mail konnte nicht gesendet werden.");
                } finally {
                    setLoading(false);
                }
            };

            const createFirestoreUserDocument = async (user, chosenUsername) => {
                const founderRef = doc(db, `artifacts/${appId}/public/data/meta`, "founder_info");
                const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                await runTransaction(db, async (transaction) => {
                    const founderDoc = await transaction.get(founderRef);
                    let role = 'user';
                    if (!founderDoc.exists()) {
                        role = 'founder';
                        transaction.set(founderRef, { founderAssigned: true, founderId: user.uid });
                    }
                    transaction.set(userDocRef, {
                        uid: user.uid, email: user.email, username: chosenUsername, role,
                        createdAt: new Date(), isBanned: false, banCount: 0, bannedBy: null,
                        photoURL: null, has2FA: false
                    });
                });
            };

            const handleRegistrationCompletion = async (e) => {
                e.preventDefault();
                setError(''); setLoading(true);
                const user = auth.currentUser;

                if (!user) {
                    setError("Sitzung abgelaufen."); setLoading(false); resetForm('login'); return;
                }
                if (!username) {
                    setError("Bitte gib einen Benutzernamen ein."); setLoading(false); return;
                }

                try {
                    const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                    const usernameQuery = query(usersRef, where("username", "==", username));
                    if (!(await getDocs(usernameQuery)).empty) throw new Error("Benutzername ist bereits vergeben.");
                    await createFirestoreUserDocument(user, username);
                    handleClose();
                } catch (err) {
                    setError(err.message || "Konto konnte nicht erstellt werden.");
                } finally {
                    setLoading(false);
                }
            };

            const handleAuth = async (e) => {
                e.preventDefault();
                setError(''); setSuccessMessage(''); setLoading(true);

                if (view === 'login') {
                    try {
                        await signInWithEmailAndPassword(auth, email, password);
                        handleClose();
                    } catch (err) {
                        if (err.code === 'auth/multi-factor-required') {
                            setMfaResolver(getMultiFactorResolver(auth, err));
                            setView('mfa');
                        } else {
                            setError('Falsche E-Mail oder Passwort.');
                        }
                    } finally {
                        setLoading(false);
                    }
                } else { // Register
                    let newUserCredential = null;
                    try {
                        if (!username) throw new Error("Bitte gib einen Benutzernamen ein.");
                        const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                        const usernameQuery = query(usersRef, where("username", "==", username));
                        if (!(await getDocs(usernameQuery)).empty) throw new Error("Benutzername ist bereits vergeben.");
                        
                        newUserCredential = await createUserWithEmailAndPassword(auth, email, password);
                        await createFirestoreUserDocument(newUserCredential.user, username);
                        handleClose();
                    } catch (err) {
                        if (newUserCredential) await deleteUser(newUserCredential.user).catch(console.error);
                        switch (err.code) {
                            case 'auth/email-already-in-use': setError('E-Mail wird bereits verwendet.'); break;
                            case 'auth/weak-password': setError('Passwort muss > 6 Zeichen sein.'); break;
                            default: setError(err.message || "Registrierung fehlgeschlagen.");
                        }
                    } finally {
                        setLoading(false);
                    }
                }
            };

            const handleMfaSignIn = async (e) => {
                e.preventDefault();
                setError('');
                setLoading(true);
                try {
                    const cred = TotpMultiFactorGenerator.assertionForSignIn(
                        mfaResolver.hints[0].uid,
                        verificationCode
                    );
                    await mfaResolver.resolveSignIn(cred);
                    handleClose();
                } catch (error) {
                    setError('Falscher Bestätigungscode.');
                } finally {
                    setLoading(false);
                }
            };

            const renderContent = () => {
                switch (view) {
                    case 'mfa': return (
                        <form onSubmit={handleMfaSignIn} className="space-y-4">
                            <p className="text-sm text-gray-300">Geben Sie den 6-stelligen Code aus Ihrer Authenticator-App ein.</p>
                            <Input type="text" placeholder="Bestätigungscode" value={verificationCode} onChange={(e) => setVerificationCode(e.target.value)} required maxLength="6" />
                            {error && <p className="text-red-400 text-sm">{error}</p>}
                            <Button type="submit" className="w-full" disabled={loading}>{loading ? 'Überprüfe...' : 'Anmelden'}</Button>
                        </form>
                    );
                    case 'completeRegistration': return (
                        <form onSubmit={handleRegistrationCompletion} className="space-y-4">
                            <p className="text-sm text-gray-300">Willkommen! Bitte Benutzernamen eingeben.</p>
                            <Input type="text" placeholder="Benutzername" value={username} onChange={(e) => setUsername(e.target.value)} required />
                            <Input type="email" value={email} disabled className="bg-gray-800" />
                            {error && <p className="text-red-400 text-sm">{error}</p>}
                            <Button type="submit" className="w-full" disabled={loading}>{loading ? 'Speichere...' : 'Registrierung abschließen'}</Button>
                        </form>
                    );
                    case 'forgotPassword': return (
                        <form onSubmit={handlePasswordReset} className="space-y-4">
                            <p className="text-sm text-gray-300">Link zum Zurücksetzen des Passworts anfordern.</p>
                            <Input type="email" placeholder="E-Mail" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            {error && <p className="text-red-400 text-sm">{error}</p>}
                            {successMessage && <p className="text-green-400 text-sm">{successMessage}</p>}
                            <Button type="submit" className="w-full" disabled={loading}>{loading ? 'Sende...' : 'E-Mail senden'}</Button>
                            <p className="text-center"><button type="button" onClick={() => resetForm('login')} className="font-semibold text-blue-500 hover:text-blue-400 text-sm">Zurück zum Login</button></p>
                        </form>
                    );
                    default: return (
                        <form onSubmit={handleAuth} className="space-y-4">
                            {view === 'register' && <Input type="text" placeholder="Benutzername" value={username} onChange={(e) => setUsername(e.target.value)} required />}
                            <Input type="email" placeholder="E-Mail" value={email} onChange={(e) => setEmail(e.target.value)} required />
                            <div className="relative">
                                <Input type={showPassword ? "text" : "password"} placeholder="Passwort" value={password} onChange={(e) => setPassword(e.target.value)} required />
                                <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-white">{showPassword ? <EyeOffIcon /> : <EyeIcon />}</button>
                            </div>
                            {view === 'login' && <div className="text-right text-sm"><button type="button" onClick={() => resetForm('forgotPassword')} className="font-semibold text-blue-500 hover:text-blue-400">Passwort vergessen?</button></div>}
                            {error && <p className="text-red-400 text-sm">{error}</p>}
                            <Button type="submit" className="w-full" disabled={loading}>{loading ? 'Lade...' : (view === 'login' ? 'Anmelden' : 'Registrieren')}</Button>
                            <p className="text-center text-sm text-gray-400">{view === 'login' ? 'Noch kein Konto?' : 'Schon ein Konto?'} <button type="button" onClick={() => resetForm(view === 'login' ? 'register' : 'login')} className="font-semibold text-blue-500 hover:text-blue-400 ml-1">{view === 'login' ? 'Registrieren' : 'Anmelden'}</button></p>
                        </form>
                    );
                }
            };
            
            const getTitle = () => {
                switch(view) {
                    case 'login': return 'Anmelden';
                    case 'register': return 'Registrieren';
                    case 'forgotPassword': return 'Passwort zurücksetzen';
                    case 'completeRegistration': return 'Registrierung abschließen';
                    case 'mfa': return 'Zwei-Faktor-Authentifizierung';
                    default: return 'Anmelden';
                }
            };

            return <Modal isOpen={isOpen} onClose={handleClose} title={getTitle()}>{renderContent()}</Modal>;
        };
        
        // --- Chat-Fenster ---
        const ChatWindow = ({ friend, currentUser, onClose }) => {
            const [messages, setMessages] = useState([]);
            const [newMessage, setNewMessage] = useState('');
            const chatEndRef = useRef(null);

            const getChatRoomId = (uid1, uid2) => [uid1, uid2].sort().join('_');

            useEffect(() => {
                if (!currentUser || !friend) return;
                const chatRoomId = getChatRoomId(currentUser.uid, friend.uid);
                const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);
                const q = query(messagesRef, orderBy("createdAt"));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const msgs = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                    setMessages(msgs);
                });

                return () => unsubscribe();
            }, [currentUser, friend]);

            useEffect(() => {
                chatEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages]);

            const handleSendMessage = async (e) => {
                e.preventDefault();
                if (!newMessage.trim() || !currentUser || !friend) return;

                const chatRoomId = getChatRoomId(currentUser.uid, friend.uid);
                const messagesRef = collection(db, `artifacts/${appId}/public/data/chats/${chatRoomId}/messages`);

                await addDoc(messagesRef, {
                    text: newMessage,
                    createdAt: serverTimestamp(),
                    senderId: currentUser.uid,
                    senderName: currentUser.username,
                });

                setNewMessage('');
            };

            return (
                <Modal isOpen={true} onClose={onClose} title={`Chat mit ${friend.username}`}>
                    <div className="h-80 flex flex-col">
                        <div className="flex-1 p-2 overflow-y-auto">
                            {messages.map(msg => (
                                <div key={msg.id} className={`flex ${msg.senderId === currentUser.uid ? 'justify-end' : 'justify-start'}`}>
                                    <div className={`max-w-xs rounded-lg px-3 py-2 my-1 ${msg.senderId === currentUser.uid ? 'bg-blue-600 text-white' : 'bg-gray-600 text-white'}`}>
                                        <p className="text-sm">{msg.text}</p>
                                    </div>
                                </div>
                            ))}
                            <div ref={chatEndRef} />
                        </div>
                        <form onSubmit={handleSendMessage} className="p-2 border-t border-gray-700 flex">
                            <Input 
                                value={newMessage}
                                onChange={(e) => setNewMessage(e.target.value)}
                                placeholder="Nachricht schreiben..."
                                className="flex-1"
                            />
                            <Button type="submit" className="ml-2">Senden</Button>
                        </form>
                    </div>
                </Modal>
            );
        };

        // --- Freunde-Panel ---
        const FriendsPanel = ({ isOpen, onClose, currentUserData, onChatStart, setNotification }) => {
            const [searchTerm, setSearchTerm] = useState('');
            const [allUsers, setAllUsers] = useState([]);
            const [friends, setFriends] = useState([]);
            const [requests, setRequests] = useState([]);
            const [sentRequests, setSentRequests] = useState([]);
            const [onlineStatus, setOnlineStatus] = useState({});
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                if(!currentUserData) return;
                
                const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                const unsubAllUsers = onSnapshot(usersRef, snapshot => {
                    setAllUsers(snapshot.docs.map(doc => doc.data()));
                    setLoading(false);
                });

                const friendsRef = collection(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/friends`);
                const unsubFriends = onSnapshot(friendsRef, snapshot => setFriends(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));
                
                const requestsRef = collection(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/friendRequests`);
                const unsubRequests = onSnapshot(requestsRef, snapshot => setRequests(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));

                const sentRequestsRef = collection(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/sentRequests`);
                const unsubSent = onSnapshot(sentRequestsRef, snapshot => setSentRequests(snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}))));

                const statusRef = dbRef(rtdb, `status/`);
                const unsubStatus = onValue(statusRef, (snapshot) => {
                    const statuses = snapshot.val() || {};
                    setOnlineStatus(statuses);
                });

                return () => { unsubAllUsers(); unsubFriends(); unsubRequests(); unsubSent(); unsubStatus(); }
            }, [currentUserData]);
            
            const sendFriendRequest = async (targetUser) => {
                if(targetUser.uid === currentUserData.uid) {
                    setNotification({type: 'error', message: 'Du kannst dich nicht selbst hinzufügen.'});
                    return;
                }
                setSentRequests(prev => [...prev, { id: targetUser.uid, username: targetUser.username }]);
                try {
                    const batch = writeBatch(db);
                    const requestRef = doc(db, `artifacts/${appId}/public/data/users/${targetUser.uid}/friendRequests`, currentUserData.uid);
                    batch.set(requestRef, { uid: currentUserData.uid, username: currentUserData.username, sentAt: serverTimestamp() });
                    const sentRef = doc(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/sentRequests`, targetUser.uid);
                    batch.set(sentRef, { uid: targetUser.uid, username: targetUser.username });
                    await batch.commit();
                    setNotification({type: 'success', message: `Anfrage an ${targetUser.username} gesendet.`});
                } catch (error) {
                    console.error("Fehler beim Senden der Freundschaftsanfrage:", error);
                    setNotification({type: 'error', message: 'Anfrage konnte nicht gesendet werden.'});
                    setSentRequests(prev => prev.filter(req => req.id !== targetUser.uid));
                }
            };

            const acceptRequest = async (request) => {
                try {
                    const batch = writeBatch(db);
                    const myFriendRef = doc(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/friends`, request.uid);
                    batch.set(myFriendRef, { username: request.username, uid: request.uid, photoURL: request.photoURL || null });
                    const theirFriendRef = doc(db, `artifacts/${appId}/public/data/users/${request.uid}/friends`, currentUserData.uid);
                    batch.set(theirFriendRef, { username: currentUserData.username, uid: currentUserData.uid, photoURL: currentUserData.photoURL || null });
                    const requestRef = doc(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/friendRequests`, request.uid);
                    batch.delete(requestRef);
                    const sentRequestRef = doc(db, `artifacts/${appId}/public/data/users/${request.uid}/sentRequests`, currentUserData.uid);
                    batch.delete(sentRequestRef);
                    await batch.commit();
                    setNotification({type: 'success', message: `${request.username} ist jetzt dein Freund.`});
                } catch (error) {
                    console.error("Fehler beim Annehmen der Anfrage:", error);
                    setNotification({type: 'error', message: 'Anfrage konnte nicht angenommen werden.'});
                }
            };

            const declineRequest = async (request) => {
                 try {
                    const batch = writeBatch(db);
                    const requestRef = doc(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/friendRequests`, request.uid);
                    batch.delete(requestRef);
                    const sentRequestRef = doc(db, `artifacts/${appId}/public/data/users/${request.uid}/sentRequests`, currentUserData.uid);
                    batch.delete(sentRequestRef);
                    await batch.commit();
                    setNotification({type: 'info', message: `Anfrage von ${request.username} abgelehnt.`});
                } catch (error) {
                    console.error("Fehler beim Ablehnen der Anfrage:", error);
                    setNotification({type: 'error', message: 'Anfrage konnte nicht abgelehnt werden.'});
                }
            };

            const cancelRequest = async (sentRequest) => {
                try {
                    const batch = writeBatch(db);
                    const sentRef = doc(db, `artifacts/${appId}/public/data/users/${currentUserData.uid}/sentRequests`, sentRequest.id);
                    batch.delete(sentRef);
                    const requestRef = doc(db, `artifacts/${appId}/public/data/users/${sentRequest.id}/friendRequests`, currentUserData.uid);
                    batch.delete(requestRef);
                    await batch.commit();
                    setNotification({type: 'info', message: `Anfrage an ${sentRequest.username} zurückgezogen.`});
                } catch (error) {
                    console.error("Fehler beim Abbrechen der Anfrage:", error);
                    setNotification({type: 'error', message: 'Anfrage konnte nicht zurückgezogen werden.'});
                }
            };

            const filteredUsers = useMemo(() => {
                if (!searchTerm) {
                    return allUsers;
                }
                return allUsers.filter(user => 
                    user.username.toLowerCase().startsWith(searchTerm.toLowerCase())
                );
            }, [searchTerm, allUsers]);

            return (
                 <Modal isOpen={isOpen} onClose={onClose} title="Freunde">
                    <div className="space-y-6">
                        <div>
                            <h3 className="font-bold text-lg mb-2">Benutzer suchen</h3>
                            <Input value={searchTerm} onChange={e => setSearchTerm(e.target.value)} placeholder="Benutzername..."/>
                            <div className="mt-2 space-y-1 max-h-24 overflow-y-auto">
                                {loading ? <Loader2Icon/> : filteredUsers.map(user => {
                                    const isFriend = friends.some(f => f.id === user.uid);
                                    const hasSentRequest = sentRequests.some(r => r.id === user.uid);
                                    const hasReceivedRequest = requests.some(r => r.id === user.uid);
                                    let buttonContent;
                                    if(user.uid === currentUserData.uid) buttonContent = null;
                                    else if (isFriend) buttonContent = <Button size="sm" disabled>Freunde</Button>;
                                    else if (hasSentRequest) buttonContent = <Button size="sm" disabled>Gesendet</Button>;
                                    else if (hasReceivedRequest) buttonContent = <Button onClick={() => acceptRequest(user)} size="sm" variant="success">Annehmen</Button>;
                                    else buttonContent = <Button onClick={() => sendFriendRequest(user)} size="sm"><UserPlusIcon className="w-4 h-4"/></Button>;

                                    return (
                                        <div key={user.uid} className="flex justify-between items-center bg-gray-700 p-2 rounded">
                                            <div className="flex items-center gap-2">
                                                <span className={`w-2 h-2 rounded-full ${onlineStatus[user.uid]?.state === 'online' ? 'bg-green-500' : 'bg-gray-500'}`}></span>
                                                <span>{user.username}</span>
                                            </div>
                                            {buttonContent}
                                        </div>
                                    )
                                })}
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-lg mb-2">Anfragen</h3>
                            <div className="space-y-1 max-h-24 overflow-y-auto">
                                {requests.length > 0 ? requests.map(req => (
                                    <div key={req.id} className="flex justify-between items-center bg-gray-700 p-2 rounded">
                                        <span>{req.username}</span>
                                        <div className="flex gap-2">
                                            <Button onClick={() => acceptRequest(req)} size="sm" variant="success"><CheckCircleIcon className="w-4 h-4"/></Button>
                                            <Button onClick={() => declineRequest(req)} size="sm" variant="danger"><XCircleIcon className="w-4 h-4"/></Button>
                                        </div>
                                    </div>
                                )) : <p className="text-sm text-gray-400">Keine neuen Anfragen.</p>}
                            </div>
                        </div>
                        
                        <div>
                            <h3 className="font-bold text-lg mb-2">Gesendete Anfragen</h3>
                            <div className="space-y-1 max-h-24 overflow-y-auto">
                                {sentRequests.length > 0 ? sentRequests.map(req => (
                                    <div key={req.id} className="flex justify-between items-center bg-gray-700 p-2 rounded">
                                        <span>{req.username}</span>
                                        <Button onClick={() => cancelRequest(req)} size="sm" variant="danger">Abbrechen</Button>
                                    </div>
                                )) : <p className="text-sm text-gray-400">Keine gesendeten Anfragen.</p>}
                            </div>
                        </div>

                        <div>
                            <h3 className="font-bold text-lg mb-2">Deine Freunde</h3>
                             <div className="space-y-1 max-h-24 overflow-y-auto">
                                {friends.length > 0 ? friends.map(friend => (
                                    <div key={friend.id} className="flex justify-between items-center bg-gray-700 p-2 rounded">
                                        <div className="flex items-center gap-2">
                                            <span className={`w-2 h-2 rounded-full ${onlineStatus[friend.id]?.state === 'online' ? 'bg-green-500' : 'bg-gray-500'}`}></span>
                                            <span>{friend.username}</span>
                                        </div>
                                        <Button onClick={() => { onChatStart(friend); onClose(); }} size="sm"><MessageSquareIcon className="w-4 h-4"/></Button>
                                    </div>
                                )) : <p className="text-sm text-gray-400">Noch keine Freunde.</p>}
                            </div>
                        </div>
                    </div>
                </Modal>
            );
        };
        
        // --- Admin Panel ---
        const AdminPanel = ({ isOpen, onClose, currentUserData, allUsers, setNotification }) => {
            const handleRoleChange = async (targetUser, newRole) => {
                if (currentUserData.role !== 'founder') {
                    setNotification({ type: 'error', message: 'Nur Gründer können Rollen ändern.' });
                    return;
                }
                if (targetUser.uid === currentUserData.uid) {
                     setNotification({ type: 'error', message: 'Du kannst deine eigene Rolle nicht ändern.' });
                    return;
                }
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, targetUser.uid);
                    await updateDoc(userDocRef, { role: newRole });
                    setNotification({ type: 'success', message: `Rolle für ${targetUser.username} aktualisiert.` });
                } catch (error) {
                    setNotification({ type: 'error', message: 'Rolle konnte nicht geändert werden.' });
                }
            };

            const handleBanToggle = async (targetUser) => {
                if (targetUser.uid === currentUserData.uid) {
                     setNotification({ type: 'error', message: 'Du kannst dich nicht selbst bannen.' });
                    return;
                }
                const isBanning = !targetUser.isBanned;
                try {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, targetUser.uid);
                    const updateData = {
                        isBanned: isBanning,
                        bannedBy: isBanning ? currentUserData.username : null,
                    };
                    if (isBanning) {
                        updateData.banCount = increment(1);
                    }
                    await updateDoc(userDocRef, updateData);
                    setNotification({ type: 'success', message: `${targetUser.username} wurde ${isBanning ? 'gebannt' : 'entbannt'}.` });
                } catch (error) {
                    setNotification({ type: 'error', message: 'Aktion fehlgeschlagen.' });
                }
            };

            const handlePasswordReset = async (email) => {
                try {
                    await sendPasswordResetEmail(auth, email);
                    setNotification({ type: 'success', message: `Passwort-Reset-E-Mail an ${email} gesendet.` });
                } catch (error) {
                    setNotification({ type: 'error', message: 'Passwort-Reset fehlgeschlagen.' });
                }
            };
            
            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Admin Panel">
                    <div className="space-y-4 max-h-[60vh] overflow-y-auto">
                        {allUsers.map(user => (
                            <div key={user.uid} className="bg-gray-800 p-4 rounded-lg">
                                <div className="flex justify-between items-center">
                                    <div>
                                        <p className="font-bold text-white">{user.username} {user.role === 'founder' && <CrownIcon />} {user.role === 'admin' && <ShieldCheckIcon />}</p>
                                        <p className="text-sm text-gray-400">{user.email}</p>
                                        {user.isBanned && <p className="text-sm text-red-400">Gebannt von: {user.bannedBy || 'Unbekannt'}</p>}
                                    </div>
                                    <div className="flex items-center gap-2">
                                        <span className="text-xs bg-gray-700 px-2 py-1 rounded-full">Bans: {user.banCount}</span>
                                        {user.isBanned ? <UserXIcon className="text-red-500"/> : <UserIcon className="text-green-500"/>}
                                    </div>
                                </div>
                                <div className="mt-3 pt-3 border-t border-gray-700 flex flex-wrap gap-2">
                                    <Button onClick={() => handleBanToggle(user)} variant={user.isBanned ? 'success' : 'danger'} size="sm" disabled={user.uid === currentUserData.uid}>
                                        {user.isBanned ? 'Entbannen' : 'Bannen'}
                                    </Button>
                                    <Button onClick={() => handlePasswordReset(user.email)} variant="secondary" size="sm">
                                        <KeyRoundIcon className="w-4 h-4"/> PW Reset
                                    </Button>
                                    {currentUserData.role === 'founder' && user.uid !== currentUserData.uid && (
                                        user.role === 'admin' ? (
                                            <Button onClick={() => handleRoleChange(user, 'user')} variant="secondary" size="sm">
                                                Admin entfernen
                                            </Button>
                                        ) : (
                                            <Button onClick={() => handleRoleChange(user, 'admin')} variant="primary" size="sm">
                                                Zu Admin machen
                                            </Button>
                                        )
                                    )}
                                </div>
                            </div>
                        ))}
                    </div>
                </Modal>
            );
        };

        // --- Notizen Komponente ---
        const NotesModal = ({ isOpen, onClose, userId, setNotification }) => {
            const [notes, setNotes] = useState([]);
            const [newNote, setNewNote] = useState('');
            const [loading, setLoading] = useState(false);

            useEffect(() => {
                if (!isOpen || !userId) return;
                
                const notesRef = collection(db, `artifacts/${appId}/public/data/notes`);
                const q = query(notesRef, where("userId", "==", userId));

                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const userNotes = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .sort((a, b) => b.createdAt.toDate() - a.createdAt.toDate());
                    setNotes(userNotes);
                }, (error) => {
                    setNotification({ type: 'error', message: 'Notizen konnten nicht geladen werden.' });
                });

                return () => unsubscribe();
            }, [isOpen, userId]);

            const handleAddNote = async (e) => {
                e.preventDefault();
                if (!newNote.trim()) return;
                setLoading(true);
                try {
                    await addDoc(collection(db, `artifacts/${appId}/public/data/notes`), {
                        userId: userId,
                        content: newNote,
                        createdAt: serverTimestamp()
                    });
                    setNewNote('');
                    setNotification({ type: 'success', message: 'Notiz hinzugefügt!' });
                } catch (error) {
                    setNotification({ type: 'error', message: 'Notiz konnte nicht hinzugefügt werden.' });
                } finally {
                    setLoading(false);
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Meine Notizen">
                    <form onSubmit={handleAddNote} className="flex gap-2 mb-4">
                        <Input 
                            type="text" 
                            placeholder="Neue Notiz..." 
                            value={newNote} 
                            onChange={(e) => setNewNote(e.target.value)}
                        />
                        <Button type="submit" disabled={loading}>{loading ? '...' : 'Speichern'}</Button>
                    </form>
                    <div className="space-y-3 max-h-[50vh] overflow-y-auto">
                        {notes.length > 0 ? (
                            notes.map(note => (
                                <div key={note.id} className="bg-gray-800 p-3 rounded-lg">
                                    <p className="text-white">{note.content}</p>
                                    <p className="text-xs text-gray-500 mt-1">{note.createdAt ? new Date(note.createdAt.toDate()).toLocaleString('de-DE') : '...'}</p>
                                </div>
                            ))
                        ) : (
                            <p className="text-gray-400 text-center">Noch keine Notizen vorhanden.</p>
                        )}
                    </div>
                </Modal>
            );
        };
        
        // --- Settings Modal ---
        const SettingsModal = ({ isOpen, onClose, user, userData, setNotification }) => {
            const [qrCode, setQrCode] = useState('');
            const [verificationCode, setVerificationCode] = useState('');
            const [mfaSecret, setMfaSecret] = useState(null);
            const [error, setError] = useState('');

            const handleEnable2FA = async () => {
                try {
                    const session = await multiFactor(user).getSession();
                    const secret = await TotpMultiFactorGenerator.generateSecret(session);
                    setMfaSecret(secret);
                    const qrCodeUri = secret.toUri();
                    
                    const qr = qrcode(0, 'L');
                    qr.addData(qrCodeUri);
                    qr.make();
                    setQrCode(qr.createDataURL(4));
                } catch (e) {
                    console.error("Fehler beim Erstellen des 2FA-Secrets:", e);
                    setError("2FA konnte nicht initialisiert werden.");
                }
            };

            const handleVerify2FA = async (e) => {
                e.preventDefault();
                setError('');
                try {
                    const multiFactorAssertion = TotpMultiFactorGenerator.assertionForEnrollment(mfaSecret, verificationCode);
                    await multiFactor(user).enroll(multiFactorAssertion, "Mein 2FA-Gerät");
                    
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                    await updateDoc(userDocRef, { has2FA: true });
                    
                    setNotification({ type: 'success', message: '2FA erfolgreich aktiviert!' });
                    onClose();
                } catch (error) {
                    console.error("Fehler bei der 2FA-Verifizierung:", error);
                    setError("Falscher Code. Bitte erneut versuchen.");
                }
            };

            return (
                <Modal isOpen={isOpen} onClose={onClose} title="Einstellungen">
                    <div className="space-y-4">
                        <h3 className="font-bold text-lg">Zwei-Faktor-Authentifizierung (2FA)</h3>
                        {userData?.has2FA ? (
                            <div className="flex items-center gap-2 text-green-400">
                                <ShieldCheckIcon />
                                <span>2FA ist für Ihr Konto aktiv.</span>
                            </div>
                        ) : (
                            <div>
                                {!qrCode ? (
                                    <Button onClick={handleEnable2FA}>2FA aktivieren</Button>
                                ) : (
                                    <form onSubmit={handleVerify2FA} className="space-y-4">
                                        <p>1. Scannen Sie diesen QR-Code mit Ihrer Authenticator-App (z.B. Google Authenticator).</p>
                                        <div className="bg-white p-2 rounded-lg inline-block">
                                            <img src={qrCode} alt="QR Code" />
                                        </div>
                                        <p>2. Geben Sie den 6-stelligen Code aus der App ein, um die Einrichtung abzuschließen.</p>
                                        <Input
                                            type="text"
                                            value={verificationCode}
                                            onChange={(e) => setVerificationCode(e.target.value)}
                                            placeholder="6-stelliger Code"
                                            maxLength="6"
                                            required
                                        />
                                        {error && <p className="text-red-400 text-sm">{error}</p>}
                                        <Button type="submit">Aktivieren & Verifizieren</Button>
                                    </form>
                                )}
                            </div>
                        )}
                    </div>
                </Modal>
            );
        };

        // --- Haupt-App-Komponente ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [userData, setUserData] = useState(null);
            const [allUsers, setAllUsers] = useState([]);
            const [loadingAuth, setLoadingAuth] = useState(true);
            
            const [isAuthModalOpen, setAuthModalOpen] = useState(false);
            const [isAdminPanelOpen, setAdminPanelOpen] = useState(false);
            const [isNotesModalOpen, setNotesModalOpen] = useState(false);
            const [isFriendsPanelOpen, setFriendsPanelOpen] = useState(false);
            const [isSettingsModalOpen, setSettingsModalOpen] = useState(false);
            const [isDropdownOpen, setDropdownOpen] = useState(false);
            const [activeChat, setActiveChat] = useState(null);
            
            const [notification, setNotification] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                if (notification) {
                    const timer = setTimeout(() => setNotification(null), 5000);
                    return () => clearTimeout(timer);
                }
            }, [notification]);

            useEffect(() => {
                if (firebaseError) { setLoadingAuth(false); return; }
                const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
                    setUser(currentUser || null);
                    if (!currentUser) {
                        setUserData(null);
                    }
                    setLoadingAuth(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (user) {
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                    const unsubscribe = onSnapshot(userDocRef, (docSnap) => {
                        if (docSnap.exists()) {
                            setUserData({...docSnap.data(), uid: user.uid});
                        } else if (auth.currentUser) {
                            // User exists in Auth, but not Firestore. Trigger completion.
                            setUserData(null); 
                            setAuthModalOpen(true);
                        }
                    }, (error) => {
                        console.error("Fehler beim Lauschen auf Benutzerdaten:", error);
                        setUserData(null);
                    });
                    
                    // Setup presence system
                    const userStatusDatabaseRef = dbRef(rtdb, '/status/' + user.uid);
                    const isOfflineForDatabase = { state: 'offline', last_changed: rtdbServerTimestamp() };
                    const isOnlineForDatabase = { state: 'online', last_changed: rtdbServerTimestamp() };
                    
                    const connectedRef = dbRef(rtdb, '.info/connected');
                    onValue(connectedRef, (snap) => {
                        if (snap.val() === true) {
                            onDisconnect(userStatusDatabaseRef).set(isOfflineForDatabase).then(() => {
                                dbSet(userStatusDatabaseRef, isOnlineForDatabase);
                            });
                        }
                    });

                    return () => unsubscribe();
                } else {
                    setUserData(null);
                }
            }, [user]);

            useEffect(() => {
                if (userData && (userData.role === 'admin' || userData.role === 'founder')) {
                    const usersRef = collection(db, `artifacts/${appId}/public/data/users`);
                    const unsubscribe = onSnapshot(usersRef, (snapshot) => {
                        setAllUsers(snapshot.docs.map(doc => doc.data()));
                    });
                    return () => unsubscribe();
                } else {
                    setAllUsers([]);
                }
            }, [userData]);

            const handleLogout = async () => {
                if (user) {
                    const userStatusDatabaseRef = dbRef(rtdb, '/status/' + user.uid);
                    await dbSet(userStatusDatabaseRef, { state: 'offline', last_changed: rtdbServerTimestamp() });
                }
                await signOut(auth);
                setDropdownOpen(false);
                setNotification({type: 'info', message: 'Erfolgreich abgemeldet.'});
            };

            const handleProfilePictureChange = async (e) => {
                const file = e.target.files[0];
                if (!file || !user) return;

                const storageRef = ref(storage, `profile-pictures/${user.uid}`);
                try {
                    await uploadBytes(storageRef, file);
                    const photoURL = await getDownloadURL(storageRef);
                    const userDocRef = doc(db, `artifacts/${appId}/public/data/users`, user.uid);
                    await updateDoc(userDocRef, { photoURL });
                    setNotification({type: 'success', message: 'Profilbild aktualisiert!'});
                } catch (error) {
                    console.error("Fehler beim Hochladen des Profilbilds:", error);
                    setNotification({type: 'error', message: 'Profilbild konnte nicht hochgeladen werden.'});
                }
            };

            if (firebaseError) {
                return <div className="bg-gray-900 min-h-screen flex items-center justify-center text-white"><XCircleIcon className="text-red-500 mr-2"/> Kritischer Fehler.</div>;
            }

            if (loadingAuth) {
                return <div className="bg-gray-900 min-h-screen flex items-center justify-center text-white"><Loader2Icon /> Lade...</div>;
            }
            
            if (userData?.isBanned) {
                return (
                    <div className="bg-gray-900 min-h-screen flex flex-col items-center justify-center text-white p-4 text-center">
                        <UserXIcon className="w-20 h-20 text-red-500 mb-4"/>
                        <h1 className="text-4xl font-bold mb-2">Du wurdest gebannt</h1>
                        <p className="text-lg text-gray-300 mb-1">Grund: Nicht so gute Aktivität.</p>
                        <p className="text-md text-gray-400 mb-4">Gebannt von: <span className="font-semibold">{userData.bannedBy || 'System'}</span></p>
                        <Card className="mt-4"><p>Dein Bann-Zähler: <span className="font-bold text-xl text-red-400">{userData.banCount}</span></p></Card>
                        <Button onClick={handleLogout} className="mt-8" variant="secondary"><LogOutIcon className="w-4 h-4"/> Abmelden</Button>
                    </div>
                );
            }

            return (
                <div className="bg-gray-900 min-h-screen text-white font-sans">
                    {notification && (
                        <div className="fixed top-5 right-5 z-50">
                             <div className={`flex items-center gap-3 p-4 rounded-lg shadow-lg text-white ${notification.type === 'success' ? 'bg-green-600' : (notification.type === 'error' ? 'bg-red-600' : 'bg-blue-600')}`}>
                                {notification.type === 'success' && <CheckCircleIcon />}
                                {notification.type === 'error' && <XCircleIcon />}
                                {notification.type === 'info' && <InfoIcon />}
                                <span>{notification.message}</span>
                                <button onClick={() => setNotification(null)} className="ml-4"><XIcon className="w-5 h-5"/></button>
                            </div>
                        </div>
                    )}

                    <header className="p-4 flex justify-between items-center border-b border-gray-800">
                        <h1 className="text-2xl font-bold text-white">Fortnite Status</h1>
                        <div className="relative">
                            {user && userData ? (
                                <div className="flex items-center gap-3">
                                    <span className="hidden sm:inline">Willkommen, <span className="font-bold">{userData.username}</span></span>
                                    {userData.role === 'founder' && <CrownIcon className="w-5 h-5 text-yellow-400" title="Gründer"/>}
                                    {userData.role === 'admin' && <ShieldCheckIcon className="w-5 h-5 text-blue-400" title="Admin"/>}
                                    <button onClick={() => setFriendsPanelOpen(true)} className="p-2 rounded-full hover:bg-gray-700" title="Freunde"><UsersIcon /></button>
                                    <button onClick={() => setDropdownOpen(!isDropdownOpen)} className="bg-gray-700 w-10 h-10 rounded-full flex items-center justify-center overflow-hidden">
                                        {userData.photoURL ? <img src={userData.photoURL} alt="Profil" className="w-full h-full object-cover" /> : <UserIcon />}
                                    </button>
                                </div>
                            ) : (
                                <button onClick={() => setAuthModalOpen(true)} title="Anmelden / Registrieren" className="bg-gray-700 w-10 h-10 rounded-full flex items-center justify-center hover:bg-gray-600 transition">
                                    {user && !userData ? <Loader2Icon /> : <UserIcon />}
                                </button>
                            )}
                            {isDropdownOpen && user && userData && (
                                <div className="absolute right-0 mt-2 w-56 bg-gray-800 rounded-lg shadow-xl z-20 border border-gray-700">
                                    <div className="p-2">
                                        <button onClick={() => { setSettingsModalOpen(true); setDropdownOpen(false); }} className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 rounded-md flex items-center gap-2">
                                            <SettingsIcon className="w-4 h-4"/> Einstellungen
                                        </button>
                                        <button onClick={() => fileInputRef.current.click()} className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 rounded-md flex items-center gap-2">
                                            <CameraIcon className="w-4 h-4"/> Profilbild ändern
                                        </button>
                                        <input type="file" ref={fileInputRef} onChange={handleProfilePictureChange} className="hidden" accept="image/*" />
                                        <div className="border-t border-gray-700 my-1"></div>
                                        {(userData.role === 'admin' || userData.role === 'founder') && (
                                            <button onClick={() => { setAdminPanelOpen(true); setDropdownOpen(false); }} className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 rounded-md flex items-center gap-2"><HammerIcon className="w-4 h-4"/> Admin Panel</button>
                                        )}
                                        <button onClick={() => { setNotesModalOpen(true); setDropdownOpen(false); }} className="w-full text-left px-4 py-2 text-sm text-white hover:bg-gray-700 rounded-md flex items-center gap-2"><NotebookIcon className="w-4 h-4"/> Meine Notizen</button>
                                        <div className="border-t border-gray-700 my-1"></div>
                                        <button onClick={handleLogout} className="w-full text-left px-4 py-2 text-sm text-red-400 hover:bg-gray-700 rounded-md flex items-center gap-2"><LogOutIcon className="w-4 h-4"/> Abmelden</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </header>

                    <main className="p-4 sm:p-6 md:p-8">
                        <div className="max-w-4xl mx-auto space-y-8">
                            <FortniteStatus />
                            <Card>
                                <h2 className="text-xl font-bold mb-3">Willkommen!</h2>
                                <p className="text-gray-300">Dies ist deine zentrale Anlaufstelle für den Fortnite-Status. Melde dich an, um Notizen zu erstellen, Freunde hinzuzufügen und mit ihnen zu chatten.</p>
                            </Card>
                        </div>
                    </main>

                    <AuthModal isOpen={isAuthModalOpen || (user && !userData)} onClose={() => setAuthModalOpen(false)} />
                    {user && userData && <SettingsModal isOpen={isSettingsModalOpen} onClose={() => setSettingsModalOpen(false)} user={user} userData={userData} setNotification={setNotification}/>}
                    {userData && (userData.role === 'admin' || userData.role === 'founder') && <AdminPanel isOpen={isAdminPanelOpen} onClose={() => setAdminPanelOpen(false)} currentUserData={userData} allUsers={allUsers} setNotification={setNotification} />}
                    {user && userData && <NotesModal isOpen={isNotesModalOpen} onClose={() => setNotesModalOpen(false)} userId={user.uid} setNotification={setNotification} />}
                    {user && userData && <FriendsPanel isOpen={isFriendsPanelOpen} onClose={() => setFriendsPanelOpen(false)} currentUserData={userData} onChatStart={setActiveChat} setNotification={setNotification} />}
                    {activeChat && userData && <ChatWindow friend={activeChat} currentUser={userData} onClose={() => setActiveChat(null)} />}
                </div>
            );
        }
        
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);
    </script>
</body>
</html>
