<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortnite Status & Community Hub</title>
    
    <!-- Tailwind CSS for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts & Icons -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* Custom styles for a modern, gaming-inspired look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0F172A; /* Darker blue */
            color: #E5E7EB;
            overflow: hidden;
        }

        /* Starry background effect */
        .stars {
            background: #0F172A url(data:image/svg+xml;base64,PHN2ZyB2ZXJzaW9uPSIxLjEiIGlkPSJMYXllcl8xIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHhtbG5zOnhsaW5rPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rIiB4PSIwcHgiIHk9IjBweCIgd2lkdGg9IjEwMHB4IiBoZWlnaHQ9IjEwMHB4IiB2aWV3Qm94PSIwIDAgMTAwIDEwMCIgZW5hYmxlLWJhY2tncm91bmQ9Im5ldyAwIDAgMTAwIDEwMCIgeG1sOnNwYWNlPSJwcmVzZXJ2ZSI+ICA8Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSIyMyIgaWQ9InN0YXIxIiBjeT0iMjMiIHI9IjAuNSIvPiAgPGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iMzMiIGlkPSJzdGFyMiIgY3k9IjMzIiByPSIwLjUiLz4gIDxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjQ1IiBpZD0ic3RhcjMiIGN5PSI0NSIgcj0iMC41Ii8+ICA8Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSI1MiIgaWQ9InN0YXI0IiBjeT0iNTIiIHI9IjAuNSIvPiAgPGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iODciIGlkPSJzdGFyNSIgY3k9Ijg3IiByPSIwLjUiLz4gIDxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9Ijc1IiBpZD0ic3RhcjYiIGN5PSI3NSIgcj0iMC41Ii8+ICA8Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSI5MiIgaWQ9InN0YXI3IiBjeT0iOTEiIHI9IjAuNSIvPiAgPGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iMTIiIGlkPSJzdGFyOCIgY3k9IjEyIiByPSIwLjUiLz4gIDxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9IjQwIiBpZD0ic3RhcjkiIGN5PSI4IiByPSIwLjUiLz4gIDxjaXJjbGUgZmlsbD0iI0ZGRkZGRiIgY3g9Ijg4IiBpZD0ic3RhcjEwIiBjeT0iMyIgcj0iMC41Ii8+ICA8Y2lyY2xlIGZpbGw9IiNGRkZGRkYiIGN4PSI5OCIgaWQ9InN0YXIxMSIgY3k9IjUiIHI9IjAuNSIvPiAgPGNpcmNsZSBmaWxsPSIjRkZGRkZGIiBjeD0iOTMiIGlkPSJzdGFyMTIiIGN5PSI5MyIgcj0iMC41Ii8+PC9zdmc+) repeat;
            position: absolute;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: -1;
            animation: move-stars 200s linear infinite;
        }

        @keyframes move-stars {
            from { background-position: 0 0; }
            to { background-position: -10000px 5000px; }
        }

        /* Glassmorphism effect for modals and cards */
        .glass-card {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
        }

        /* Animation for modals */
        .modal-enter { animation: fadeIn 0.3s ease-out forwards; }
        .modal-leave { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

        /* Custom button styles */
        .btn-primary { @apply bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-lg transform transition-all duration-300; }
        .btn-primary:hover { @apply bg-blue-500 scale-105 shadow-blue-500/50; }
        .btn-secondary { @apply bg-slate-700 text-white font-bold py-2 px-4 rounded-lg shadow-md transform transition-all duration-300; }
        .btn-secondary:hover { @apply bg-slate-600 scale-105; }
        
        /* Loading spinner */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3B82F6; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="w-full h-screen">

    <div class="stars"></div>

    <!-- Main Application Container -->
    <div id="app-container" class="w-full h-full flex flex-col">
        
        <!-- Header -->
        <header class="w-full p-4 flex justify-between items-center">
            <h1 id="header-title" class="text-xl font-bold text-white">Fortnite Status</h1>
            <div id="header-actions" class="flex items-center gap-4">
                <!-- Logged in actions will be injected here -->
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="flex-grow flex flex-col p-4 overflow-y-auto">
            <!-- Content is rendered dynamically by JS -->
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-backdrop" class="hidden fixed inset-0 bg-black/50 z-40"></div>
    
    <!-- Auth Modal -->
    <div id="auth-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4 modal-enter">
        <div class="glass-card w-full max-w-md p-8 shadow-2xl">
            <div class="flex justify-between items-center mb-6">
                <h2 id="auth-title" class="text-2xl font-bold text-white">Anmelden</h2>
                <button id="close-auth-modal" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div id="auth-content"></div>
        </div>
    </div>

    <!-- Chats & Friends Modal -->
    <div id="chats-friends-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4 modal-enter">
        <div class="glass-card w-full max-w-2xl h-[70vh] flex flex-col p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-white">Chats & Freunde</h2>
                <button id="close-chats-friends-modal" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div class="border-b border-slate-700">
                <nav class="flex space-x-4">
                    <button data-tab="chats" class="tab-btn py-2 px-4 text-white border-b-2 border-blue-500 font-semibold">Chats</button>
                    <button data-tab="friends" class="tab-btn py-2 px-4 text-gray-400 border-b-2 border-transparent hover:border-gray-500">Freunde</button>
                </nav>
            </div>
            <div id="chats-friends-content" class="overflow-y-auto flex-grow mt-4"></div>
        </div>
    </div>
    
    <!-- Other Modals (Notes, Settings, Profile Pic, Admin, Video Player) will use this generic structure -->
    <div id="generic-modal" class="hidden fixed inset-0 flex items-center justify-center z-50 p-4 modal-enter">
        <div class="glass-card w-full max-w-4xl h-auto max-h-[90vh] flex flex-col p-6 shadow-2xl">
            <div class="flex justify-between items-center mb-4 pb-4 border-b border-slate-700">
                <h2 id="generic-modal-title" class="text-2xl font-bold text-white"></h2>
                <button id="close-generic-modal" class="text-gray-400 hover:text-white"><i data-lucide="x"></i></button>
            </div>
            <div id="generic-modal-content" class="overflow-y-auto flex-grow"></div>
            <div id="generic-modal-footer" class="mt-4 pt-4 border-t border-slate-700"></div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="hidden fixed inset-0 bg-black/70 z-[100] flex flex-col items-center justify-center">
        <div class="loader"></div>
        <p id="loading-text" class="text-white mt-4 text-lg">Lade...</p>
    </div>

    <!-- Custom Toast Notification -->
    <div id="toast" class="hidden fixed bottom-5 right-5 glass-card p-4 rounded-lg shadow-lg z-[101] flex items-center gap-3">
        <i id="toast-icon" data-lucide="check-circle" class="text-green-400"></i>
        <p id="toast-message"></p>
    </div>


    <!-- Firebase SDKs -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getStorage, ref, getDownloadURL, uploadBytesResumable } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, updateProfile, deleteUser, sendEmailVerification } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, getDocs, collection, writeBatch, serverTimestamp, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, addDoc, orderBy, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- FIREBASE CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyB3Fqc0P3TmSb80GupZrXONZiejStgk6TE",
            authDomain: "social-media-1711a.firebaseapp.com",
            projectId: "social-media-1711a",
            storageBucket: "social-media-1711a.appspot.com",
            messagingSenderId: "228987477362",
            appId: "1:228987477362:web:0aa477a08b4d14572e51eb",
            measurementId: "G-SNQC7S4CJB"
        };

        // --- APP INITIALIZATION ---
        let app, auth, db, storage;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            storage = getStorage(app);
        } catch (e) {
            document.getElementById('main-content').innerHTML = `<div class="text-center p-8"><h2 class="text-2xl font-bold text-red-500">Fehler bei der Firebase-Initialisierung!</h2><p class="mt-2 text-gray-400">Fehler: ${e.message}</p></div>`;
            console.error("Firebase initialization failed:", e);
        }
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fortnite-social-app';

        // --- DOM ELEMENT REFERENCES ---
        const mainContent = document.getElementById('main-content');
        const headerTitle = document.getElementById('header-title');
        const headerActions = document.getElementById('header-actions');
        const loadingOverlay = document.getElementById('loading-overlay');
        const modalBackdrop = document.getElementById('modal-backdrop');
        const authModal = document.getElementById('auth-modal');
        const chatsFriendsModal = document.getElementById('chats-friends-modal');
        const genericModal = document.getElementById('generic-modal');
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        let currentUserProfile = null;
        let unsubscribeUserListener = null;
        let isRegistering = false;
        let typingTimeout = null;

        // --- HELPER & MODAL FUNCTIONS ---
        const showLoader = (text = 'Lade...') => {
            document.getElementById('loading-text').textContent = text;
            loadingOverlay.classList.remove('hidden');
        };
        const hideLoader = () => {
            loadingOverlay.classList.add('hidden');
        };
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            const toastIcon = document.getElementById('toast-icon');
            toastMessage.textContent = message;
            toast.classList.remove('hidden');
            if (type === 'success') {
                toastIcon.setAttribute('data-lucide', 'check-circle');
                toastIcon.setAttribute('class', 'text-green-400');
            } else if (type === 'error') {
                toastIcon.setAttribute('data-lucide', 'alert-circle');
                toastIcon.setAttribute('class', 'text-red-400');
            } else {
                toastIcon.setAttribute('data-lucide', 'info');
                toastIcon.setAttribute('class', 'text-blue-400');
            }
            lucide.createIcons();
            setTimeout(() => { toast.classList.add('hidden') }, 3000);
        };
        const openModal = (modalElement) => {
            modalBackdrop.classList.remove('hidden');
            modalElement.classList.remove('hidden', 'modal-leave');
            modalElement.classList.add('modal-enter');
        };
        const closeModal = (modalElement) => {
            modalElement.classList.remove('modal-enter');
            modalElement.classList.add('modal-leave');
            setTimeout(() => {
                modalElement.classList.add('hidden');
                if (!document.querySelector('.modal-enter:not(.hidden)')) {
                    modalBackdrop.classList.add('hidden');
                }
            }, 300);
        };
        const showConfirmationModal = (message, onConfirm) => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Bestätigung';
            modalContent.innerHTML = `<p class="text-gray-300">${message}</p>`;
            modalFooter.innerHTML = `
                <div class="flex justify-end gap-4">
                    <button id="confirm-cancel-btn" class="btn-secondary">Abbrechen</button>
                    <button id="confirm-ok-btn" class="btn-primary bg-red-600 hover:bg-red-500">Bestätigen</button>
                </div>
            `;
            openModal(genericModal);
            document.getElementById('confirm-ok-btn').onclick = () => { onConfirm(); closeModal(genericModal); };
            document.getElementById('confirm-cancel-btn').onclick = () => closeModal(genericModal);
        };

        // --- AUTHENTICATION LOGIC ---
        const handleLogout = async () => {
            showLoader('Abmelden...');
            try {
                await signOut(auth);
                showToast('Erfolgreich abgemeldet.', 'info');
            } catch (error) {
                showToast(`Fehler beim Abmelden: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        };

        onAuthStateChanged(auth, async (user) => {
            if (isRegistering) { return; }

            if (user) {
                currentUser = user; 
                if (unsubscribeUserListener) unsubscribeUserListener();
                const userDocRef = doc(db, `users/${user.uid}`);
                unsubscribeUserListener = onSnapshot(userDocRef, async (docSnap) => {
                    if (docSnap.exists()) {
                        currentUserProfile = { id: docSnap.id, ...docSnap.data() };
                        if (currentUserProfile.banned) {
                            await renderBannedScreen();
                        } else if (!user.emailVerified) {
                            renderVerificationScreen();
                        } else {
                            updateUIForLoggedInUser();
                        }
                    } else {
                        if (currentUserProfile) {
                            console.error("User document was deleted. Logging out.");
                            handleLogout();
                        }
                    }
                });
            } else {
                currentUser = null;
                currentUserProfile = null; 
                if (unsubscribeUserListener) unsubscribeUserListener();
                updateUIForLoggedOutUser();
            }
        });

        const updateUIForLoggedInUser = () => {
            const crownIcon = currentUserProfile.role === 'founder' || currentUserProfile.role === 'admin' ? `<i data-lucide="crown" class="w-5 h-5 text-yellow-400"></i>` : '';
            headerTitle.innerHTML = `<span class="flex items-center gap-2">Willkommen, ${currentUserProfile.displayName} ${crownIcon}</span>`;
            headerActions.innerHTML = `
                <button id="chat-button" class="text-gray-300 hover:text-white"><i data-lucide="message-square"></i></button>
                <div class="relative">
                    <button id="profile-button-logged-in" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600">
                        <img src="${currentUserProfile.photoURL || `https://placehold.co/40x40/1E293B/FFFFFF?text=${currentUserProfile.displayName.charAt(0)}`}" class="w-10 h-10 rounded-full object-cover">
                    </button>
                    <div id="user-dropdown-logged-in" class="hidden absolute right-0 top-12 w-56 glass-card shadow-lg z-50 p-2">
                        <a href="#" id="upload-video-btn" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-slate-700 rounded-md"><i data-lucide="video" class="w-4 h-4"></i> Video hochladen</a>
                        <a href="#" id="change-pic-btn" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-slate-700 rounded-md"><i data-lucide="camera" class="w-4 h-4"></i> Profilbild ändern</a>
                        <a href="#" id="notes-btn" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-slate-700 rounded-md"><i data-lucide="notebook" class="w-4 h-4"></i> Meine Notizen</a>
                        ${currentUserProfile.role !== 'user' ? `<a href="#" id="admin-panel-btn" class="flex items-center gap-3 px-3 py-2 text-sm text-gray-300 hover:bg-slate-700 rounded-md"><i data-lucide="shield" class="w-4 h-4"></i> Admin Panel</a>` : ''}
                        <div class="border-t border-slate-700 my-1"></div>
                        <a href="#" id="logout-btn" class="flex items-center gap-3 px-3 py-2 text-sm text-red-400 hover:bg-red-500 hover:text-white rounded-md"><i data-lucide="log-out" class="w-4 h-4"></i> Abmelden</a>
                    </div>
                </div>`;
            document.getElementById('profile-button-logged-in').addEventListener('click', () => document.getElementById('user-dropdown-logged-in').classList.toggle('hidden'));
            document.getElementById('chat-button').addEventListener('click', openChatsAndFriendsModal);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            document.getElementById('upload-video-btn').addEventListener('click', showUploadVideoModal);
            document.getElementById('change-pic-btn').addEventListener('click', showProfilePicModal);
            document.getElementById('notes-btn').addEventListener('click', showNotesModal);
            if (document.getElementById('admin-panel-btn')) {
                document.getElementById('admin-panel-btn').addEventListener('click', showAdminPanel);
            }
            lucide.createIcons();
            renderVideoFeedView();
        };

        const updateUIForLoggedOutUser = () => {
            headerTitle.textContent = 'Fortnite Status';
            headerActions.innerHTML = `<button id="profile-button-logged-out" class="w-10 h-10 rounded-full bg-slate-700 flex items-center justify-center hover:bg-slate-600"><i data-lucide="user" class="w-6 h-6 text-gray-400"></i></button>`;
            document.getElementById('profile-button-logged-out').addEventListener('click', () => showAuthModal('login'));
            lucide.createIcons();
            renderLoggedOutView();
        };
        
        const renderLoggedOutView = () => {
            mainContent.innerHTML = `
            <div class="w-full max-w-2xl space-y-6 mx-auto">
                <div class="glass-card p-6 flex justify-between items-center">
                    <div>
                        <h2 class="text-xl font-bold">Epic Games-Dienststatus</h2>
                        <p class="text-gray-400">All Systems Operational</p>
                    </div>
                    <div class="flex items-center gap-2 text-green-400">
                        <i data-lucide="check-circle-2"></i>
                        <span>Alle Systeme operationell</span>
                    </div>
                </div>
                <div class="glass-card p-6">
                    <h2 class="text-xl font-bold">Willkommen!</h2>
                    <p class="text-gray-400 mt-2">Dies ist deine zentrale Anlaufstelle für den Fortnite-Status. Melde dich an, um Videos anzusehen und die Chat-Funktionen zu nutzen!</p>
                </div>
            </div>`;
            lucide.createIcons();
        };

        const renderVerificationScreen = () => {
            headerTitle.textContent = 'E-Mail Bestätigung';
            headerActions.innerHTML = `<button id="logout-btn" class="btn-secondary">Abmelden</button>`;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            mainContent.innerHTML = `
            <div class="w-full max-w-2xl space-y-6 mx-auto text-center">
                <div class="glass-card p-8">
                    <i data-lucide="mail-check" class="w-16 h-16 mx-auto text-blue-400 mb-4"></i>
                    <h2 class="text-2xl font-bold">Bestätige deine E-Mail-Adresse</h2>
                    <p class="text-gray-400 mt-2 mb-6">Wir haben eine Bestätigungs-E-Mail an <strong>${auth.currentUser.email}</strong> gesendet. Bitte klicke auf den Link in der E-Mail, um dein Konto zu aktivieren.</p>
                    <div class="flex flex-col sm:flex-row gap-4 justify-center">
                        <button id="resend-verification-btn" class="btn-primary">E-Mail erneut senden</button>
                        <button id="check-verification-btn" class="btn-secondary">Ich habe verifiziert, weiter</button>
                    </div>
                </div>
            </div>`;
            lucide.createIcons();

            document.getElementById('resend-verification-btn').addEventListener('click', async () => {
                try {
                    await sendEmailVerification(auth.currentUser);
                    showToast("Bestätigungs-E-Mail wurde erneut gesendet.", "success");
                } catch (error) {
                    showToast("Fehler beim Senden der E-Mail.", "error");
                }
            });
            document.getElementById('check-verification-btn').addEventListener('click', async () => {
                await auth.currentUser.reload();
            });
        };
        
        const renderBannedScreen = async () => {
            headerTitle.textContent = 'Konto gesperrt';
            headerActions.innerHTML = `<button id="logout-btn" class="btn-secondary">Abmelden</button>`;
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            let bannerName = 'einem Administrator';
            if (currentUserProfile.bannedBy) {
                const bannerDoc = await getDoc(doc(db, 'users', currentUserProfile.bannedBy));
                if (bannerDoc.exists()) {
                    bannerName = bannerDoc.data().displayName;
                }
            }

            mainContent.innerHTML = `
            <div class="w-full max-w-2xl space-y-6 mx-auto text-center">
                <div class="glass-card p-8">
                    <i data-lucide="gavel" class="w-16 h-16 mx-auto text-red-500 mb-4"></i>
                    <h2 class="text-2xl font-bold">Dein Konto wurde gesperrt</h2>
                    <p class="text-gray-400 mt-2">Du wurdest von <strong>${bannerName}</strong> gesperrt. Du hast keinen Zugriff auf die App-Funktionen.</p>
                </div>
            </div>`;
            lucide.createIcons();
        };

        const showAuthModal = (view = 'login') => {
            const authContent = document.getElementById('auth-content');
            const authTitle = document.getElementById('auth-title');
            if (view === 'login') {
                authTitle.textContent = 'Anmelden';
                authContent.innerHTML = `
                    <form id="login-form">
                        <input type="email" id="login-email" placeholder="E-Mail" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-4" required>
                        <input type="password" id="login-password" placeholder="Passwort" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-4" required>
                        <button type="submit" class="btn-primary w-full">Anmelden</button>
                    </form>
                    <p class="text-center mt-4 text-sm text-gray-400">Noch kein Konto? <a href="#" id="show-register" class="text-blue-400 hover:underline">Registrieren</a></p>`;
                document.getElementById('show-register').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('register'); });
                document.getElementById('login-form').addEventListener('submit', handleLogin);
            } else {
                authTitle.textContent = 'Registrieren';
                authContent.innerHTML = `
                    <form id="register-form">
                        <input type="text" id="register-displayname" placeholder="Anzeigename" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-4" required>
                        <input type="email" id="register-email" placeholder="E-Mail" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-4" required>
                        <input type="password" id="register-password" placeholder="Passwort" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-6" required>
                        <button type="submit" class="btn-primary w-full">Konto erstellen</button>
                    </form>
                    <p class="text-center mt-4 text-sm text-gray-400">Bereits ein Konto? <a href="#" id="show-login" class="text-blue-400 hover:underline">Anmelden</a></p>`;
                document.getElementById('show-login').addEventListener('click', (e) => { e.preventDefault(); showAuthModal('login'); });
                document.getElementById('register-form').addEventListener('submit', handleRegister);
            }
            openModal(authModal);
        };

        const handleLogin = async (e) => {
            e.preventDefault();
            showLoader('Anmelden...');
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                closeModal(authModal);
            } catch (error) {
                if (error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                    showToast('Für diese E-Mail-Adresse wurde kein Konto gefunden.', 'error');
                } else if (error.code === 'auth/wrong-password') {
                    showToast('Falsches Passwort. Bitte versuche es erneut.', 'error');
                } else {
                    showToast(`Fehler bei der Anmeldung: ${error.message}`, 'error');
                }
            } finally {
                hideLoader();
            }
        };
        const handleRegister = async (e) => {
            e.preventDefault();
            showLoader('Konto wird erstellt...');
            const displayName = document.getElementById('register-displayname').value;
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            if (displayName.length < 3) { showToast('Anzeigename muss mindestens 3 Zeichen lang sein.', 'error'); hideLoader(); return; }
            
            isRegistering = true;
            let tempUser = null; 

            try {
                const metadataRef = doc(db, `app-metadata/${appId}`);
                const metadataSnap = await getDoc(metadataRef);
                let role = 'user';
                let isFounder = false;
                if (!metadataSnap.exists() || !metadataSnap.data().founderId) {
                    role = 'founder';
                    isFounder = true;
                }
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                tempUser = userCredential.user; 

                await updateProfile(tempUser, { displayName });
                const userDocRef = doc(db, `users/${tempUser.uid}`);
                await setDoc(userDocRef, { uid: tempUser.uid, displayName, email, role, createdAt: serverTimestamp(), photoURL: '', friends: [], banned: false, banCount: 0, bannedBy: null });
                
                if (isFounder) {
                    await setDoc(metadataRef, { founderId: tempUser.uid });
                }
                
                await sendEmailVerification(tempUser);
                showToast('Registrierung erfolgreich! Bitte überprüfe dein Postfach zur Verifizierung.', 'success');
                closeModal(authModal);
            } catch (error) {
                if (tempUser) {
                    await deleteUser(tempUser).catch(delErr => console.error("Failed to delete temporary user:", delErr));
                }
                if (error.code === 'auth/email-already-in-use') {
                    showToast('Diese E-Mail-Adresse wird bereits verwendet.', 'error');
                } else {
                    showToast(`Fehler bei der Registrierung: ${error.message}`, 'error');
                }
            } finally {
                isRegistering = false;
                if (auth.currentUser && auth.currentUser.uid === tempUser?.uid && !auth.currentUser.emailVerified) {
                    await signOut(auth);
                }
                hideLoader();
            }
        };

        // --- VIDEO FEED & PLAYER ---
        const renderVideoFeedView = () => {
            mainContent.innerHTML = `
                <div class="w-full max-w-7xl mx-auto">
                    <div class="glass-card p-4 mb-6 flex justify-between items-center">
                        <h2 class="text-lg font-bold">Epic Games-Dienststatus</h2>
                        <div class="flex items-center gap-2 text-green-400">
                            <i data-lucide="check-circle-2"></i>
                            <span>Alle Systeme operationell</span>
                        </div>
                    </div>
                    <div id="video-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                </div>`;
            lucide.createIcons();
            const videosQuery = query(collection(db, "videos"), orderBy("createdAt", "desc"));
            onSnapshot(videosQuery, (snapshot) => {
                const videoGrid = document.getElementById('video-grid');
                if (!videoGrid) return;
                videoGrid.innerHTML = '';
                if (snapshot.empty) { videoGrid.innerHTML = `<p class="col-span-full text-center text-gray-400">Noch keine Videos vorhanden. Lade das erste hoch!</p>`; }
                snapshot.forEach(doc => {
                    const video = { id: doc.id, ...doc.data() };
                    const card = document.createElement('div');
                    card.className = 'glass-card rounded-lg overflow-hidden cursor-pointer group';
                    card.innerHTML = `
                        <div class="relative"><img src="${video.thumbnailUrl}" alt="${video.title}" class="w-full h-48 object-cover transition-transform duration-300 group-hover:scale-105"><div class="absolute bottom-2 right-2 bg-black/50 text-white text-xs px-2 py-1 rounded-md flex items-center gap-1"><i data-lucide="eye" class="w-4 h-4"></i><span>${video.views || 0}</span></div></div>
                        <div class="p-4"><h3 class="font-bold text-white truncate">${video.title}</h3><p class="text-sm text-gray-400">${video.uploaderName}</p></div>`;
                    card.addEventListener('click', () => openVideoPlayer(video.id));
                    videoGrid.appendChild(card);
                });
                lucide.createIcons();
            });
        };

        const openVideoPlayer = async (videoId) => {
            const videoRef = doc(db, "videos", videoId);
            await updateDoc(videoRef, { views: increment(1) });
            const videoSnap = await getDoc(videoRef);
            if (!videoSnap.exists()) { showToast("Video nicht gefunden.", "error"); return; }
            const video = { id: videoSnap.id, ...videoSnap.data() };
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = video.title;
            modalContent.innerHTML = `
                <video controls autoplay class="w-full rounded-lg bg-black max-h-[60vh]"><source src="${video.videoUrl}" type="video/mp4"></video>
                <div class="mt-4 flex justify-between items-center"><p class="text-gray-400">Hochgeladen von ${video.uploaderName}</p><button id="like-video-btn" class="flex items-center gap-2 btn-secondary"><i data-lucide="heart"></i><span id="like-count">${video.likes?.length || 0}</span></button></div>
                <div class="mt-4 border-t border-slate-700 pt-4"><h4 class="font-semibold mb-2 text-lg">Kommentare</h4><div id="video-comments" class="space-y-3 max-h-40 overflow-y-auto"></div></div>`;
            modalFooter.innerHTML = `<form id="add-comment-form" class="flex gap-2"><input id="comment-input" class="flex-grow p-2 bg-slate-800 border border-slate-700 rounded-lg" placeholder="Kommentar hinzufügen..." autocomplete="off"><button type="submit" class="btn-primary">Senden</button></form>`;
            openModal(genericModal);
            updateLikeButton(videoId);
            renderComments(videoId);
            document.getElementById('like-video-btn').addEventListener('click', () => toggleLike(videoId));
            document.getElementById('add-comment-form').addEventListener('submit', (e) => { e.preventDefault(); const input = document.getElementById('comment-input'); addComment(videoId, input.value); input.value = ''; });
            lucide.createIcons();
        };

        const updateLikeButton = async (videoId) => {
            const likeBtn = document.getElementById('like-video-btn');
            if(!likeBtn) return;
            const likeIcon = likeBtn.querySelector('i');
            const likeCount = document.getElementById('like-count');
            if (!currentUser) return;
            const videoRef = doc(db, "videos", videoId);
            const videoSnap = await getDoc(videoRef);
            if (videoSnap.exists()) {
                const likes = videoSnap.data().likes || [];
                likeCount.textContent = likes.length;
                if (likes.includes(currentUser.uid)) { likeIcon.classList.add('fill-current', 'text-red-500'); } else { likeIcon.classList.remove('fill-current', 'text-red-500'); }
            }
        };

        const toggleLike = async (videoId) => {
            if (!currentUser) { showToast("Bitte anmelden, um zu liken.", "info"); return; }
            const videoRef = doc(db, "videos", videoId);
            const videoSnap = await getDoc(videoRef);
            if(videoSnap.exists()){
                const likes = videoSnap.data().likes || [];
                if(likes.includes(currentUser.uid)){ await updateDoc(videoRef, { likes: arrayRemove(currentUser.uid) }); } else { await updateDoc(videoRef, { likes: arrayUnion(currentUser.uid) }); }
                updateLikeButton(videoId);
            }
        };

        const renderComments = (videoId) => {
            const container = document.getElementById('video-comments');
            if(!container) return;
            const q = query(collection(db, `videos/${videoId}/comments`), orderBy('createdAt', 'asc'));
            onSnapshot(q, (snapshot) => {
                container.innerHTML = '';
                if(snapshot.empty){ container.innerHTML = '<p class="text-gray-500">Noch keine Kommentare.</p>'; return; }
                snapshot.forEach(doc => {
                    const comment = doc.data();
                    const commentEl = document.createElement('div');
                    commentEl.className = 'text-sm bg-slate-800/50 p-3 rounded-lg';
                    commentEl.innerHTML = `<p><span class="font-bold text-blue-300">${comment.authorName}:</span> ${comment.text}</p>`;
                    container.appendChild(commentEl);
                });
            });
        };

        const addComment = async (videoId, text) => {
            if (!text.trim()) return;
            await addDoc(collection(db, `videos/${videoId}/comments`), { text, authorId: currentUser.uid, authorName: currentUserProfile.displayName, createdAt: serverTimestamp() });
        };

        const showUploadVideoModal = () => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Video hochladen';
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Video-Titel</label><input type="text" id="video-title-input" placeholder="Mein cooler Clip" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg" required></div>
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Vorschaubild</label><input type="file" id="thumbnail-upload-input" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500" accept="image/*" required></div>
                    <div><label class="block text-sm font-medium text-gray-300 mb-1">Videodatei</label><input type="file" id="video-upload-input" class="w-full text-sm text-gray-400 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-500" accept="video/mp4,video/quicktime" required></div>
                </div>`;
            modalFooter.innerHTML = `<button id="submit-video-upload" class="btn-primary w-full">Hochladen</button>`;
            openModal(genericModal);
            document.getElementById('submit-video-upload').addEventListener('click', async () => {
                const title = document.getElementById('video-title-input').value;
                const thumbnailFile = document.getElementById('thumbnail-upload-input').files[0];
                const videoFile = document.getElementById('video-upload-input').files[0];
                if (!title || !thumbnailFile || !videoFile) { showToast("Bitte alle Felder ausfüllen.", "error"); return; }
                
                modalContent.innerHTML = `
                    <div id="upload-progress-container">
                        <p id="upload-status-text" class="text-center mb-2">Lade Vorschaubild hoch...</p>
                        <div class="w-full bg-slate-700 rounded-full h-4"><div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                        <p id="progress-percentage" class="text-center text-sm mt-1">0%</p>
                        <p id="time-remaining" class="text-center text-xs text-gray-400 mt-1"></p>
                    </div>`;
                modalFooter.innerHTML = '';

                const uploadFile = (file, storageRef, statusText) => {
                    return new Promise((resolve, reject) => {
                        const uploadTask = uploadBytesResumable(storageRef, file);
                        const uploadStartTime = Date.now();
                        document.getElementById('upload-status-text').textContent = statusText;

                        uploadTask.on('state_changed', 
                            (snapshot) => {
                                const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                                document.getElementById('progress-bar').style.width = progress + '%';
                                document.getElementById('progress-percentage').textContent = Math.round(progress) + '%';
                                
                                const elapsedTime = (Date.now() - uploadStartTime) / 1000;
                                if (elapsedTime > 0.5 && snapshot.bytesTransferred > 0) {
                                    const uploadSpeed = snapshot.bytesTransferred / elapsedTime;
                                    const bytesRemaining = snapshot.totalBytes - snapshot.bytesTransferred;
                                    const secondsRemaining = Math.round(bytesRemaining / uploadSpeed);
                                    if (isFinite(secondsRemaining) && secondsRemaining > 0) {
                                        document.getElementById('time-remaining').textContent = `Verbleibende Zeit: ca. ${secondsRemaining} Sekunden`;
                                    } else {
                                        document.getElementById('time-remaining').textContent = 'Berechne...';
                                    }
                                }
                            }, 
                            (error) => { console.error("Upload failed:", error); reject(error); }, 
                            async () => {
                                const downloadURL = await getDownloadURL(uploadTask.snapshot.ref);
                                resolve(downloadURL);
                            }
                        );
                    });
                };

                try {
                    const thumbRef = ref(storage, `thumbnails/${Date.now()}_${thumbnailFile.name}`);
                    const thumbnailUrl = await uploadFile(thumbnailFile, thumbRef, 'Lade Vorschaubild hoch...');
                    
                    const videoRef = ref(storage, `videos/${Date.now()}_${videoFile.name}`);
                    const videoUrl = await uploadFile(videoFile, videoRef, 'Lade Video hoch...');
                    
                    document.getElementById('upload-status-text').textContent = 'Verarbeite Daten...';
                    await addDoc(collection(db, "videos"), { title, thumbnailUrl, videoUrl, uploaderId: currentUser.uid, uploaderName: currentUserProfile.displayName, views: 0, likes: [], createdAt: serverTimestamp() });
                    
                    showToast("Video erfolgreich hochgeladen!", "success");
                    closeModal(genericModal);
                } catch (error) {
                    showToast("Fehler beim Hochladen.", "error");
                    closeModal(genericModal);
                }
            });
        };

        // --- CHATS & FRIENDS MODAL ---
        const openChatsAndFriendsModal = () => {
            openModal(chatsFriendsModal);
            renderChatsTab();
            chatsFriendsModal.querySelectorAll('.tab-btn').forEach(btn => {
                btn.onclick = (e) => {
                    chatsFriendsModal.querySelectorAll('.tab-btn').forEach(b => { b.classList.remove('text-white', 'border-blue-500'); b.classList.add('text-gray-400', 'border-transparent'); });
                    e.currentTarget.classList.add('text-white', 'border-blue-500'); e.currentTarget.classList.remove('text-gray-400', 'border-transparent');
                    if (e.currentTarget.dataset.tab === 'chats') renderChatsTab(); else renderFriendsTab();
                };
            });
        };
        
        const renderChatsTab = () => {
            const contentArea = document.getElementById('chats-friends-content');
            contentArea.innerHTML = `<div class="flex justify-end mb-4"><button id="create-group-btn" class="btn-primary text-sm">Neue Gruppe erstellen</button></div><div id="chats-list" class="space-y-2"></div>`;
            document.getElementById('create-group-btn').addEventListener('click', showCreateGroupModal);
            const groupsQuery = query(collection(db, 'groups'), where('members', 'array-contains', currentUser.uid));
            onSnapshot(groupsQuery, (snapshot) => {
                const list = document.getElementById('chats-list'); if (!list) return; list.innerHTML = '';
                if(snapshot.empty) { list.innerHTML = `<p class="text-center text-gray-500 mt-8">Keine Gruppen-Chats vorhanden.</p>`; }
                snapshot.forEach(doc => {
                    const group = { id: doc.id, ...doc.data() };
                    const chatItem = document.createElement('div');
                    chatItem.className = 'p-3 glass-card rounded-lg flex justify-between items-center cursor-pointer hover:bg-slate-700';
                    chatItem.innerHTML = `<div><p class="font-bold">${group.name}</p><p class="text-sm text-gray-400">${group.members.length} Mitglieder</p></div><i data-lucide="chevron-right"></i>`;
                    chatItem.addEventListener('click', () => openGroupChat(group.id, group.name));
                    list.appendChild(chatItem);
                });
                lucide.createIcons();
            });
        };

        const renderFriendsTab = () => {
            const contentArea = document.getElementById('chats-friends-content');
            contentArea.innerHTML = `
                <div class="flex justify-end mb-4"><button id="add-friend-btn" class="btn-primary text-sm">Freund hinzufügen</button></div>
                <div id="friend-requests-container" class="mb-6"><h3 class="text-lg font-semibold mb-2">Anfragen</h3><div id="friend-requests-list" class="space-y-2"></div></div>
                <div><h3 class="text-lg font-semibold mb-2">Freundesliste</h3><div id="friends-list" class="space-y-2"></div></div>`;
            document.getElementById('add-friend-btn').addEventListener('click', showAddFriendModal);
            const userDocRef = doc(db, `users/${currentUser.uid}`);
            onSnapshot(userDocRef, async (docSnap) => {
                if (docSnap.exists()) {
                    const userData = docSnap.data();
                    displayFriendRequests(userData.friendRequestsReceived || []);
                    displayFriends(userData.friends || []);
                }
            });
        };

        const showAddFriendModal = () => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Freund hinzufügen';
            modalContent.innerHTML = `<p class="text-gray-400 mb-4">Suche nach dem Anzeigenamen.</p><input type="text" id="search-user-input" placeholder="Nutzer suchen..." class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg"><div id="search-results" class="mt-4 space-y-2"></div>`;
            modalFooter.innerHTML = '';
            openModal(genericModal);
            document.getElementById('search-user-input').addEventListener('keyup', async (e) => {
                const searchTerm = e.target.value.trim();
                if (searchTerm.length < 3) { document.getElementById('search-results').innerHTML = ''; return; }
                const usersRef = collection(db, "users");
                const q = query(usersRef, where("displayName", ">=", searchTerm), where("displayName", "<=", searchTerm + '\uf8ff'));
                const querySnapshot = await getDocs(q);
                const resultsContainer = document.getElementById('search-results');
                resultsContainer.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const user = {id: doc.id, ...doc.data()};
                    if (user.id === currentUser.uid) return;
                    const isFriend = currentUserProfile.friends.includes(user.id);
                    const userCard = document.createElement('div');
                    userCard.className = 'glass-card p-3 flex items-center justify-between';
                    userCard.innerHTML = `<div class="flex items-center gap-3"><img src="${user.photoURL || `https://placehold.co/40x40/1E293B/FFFFFF?text=${user.displayName.charAt(0)}`}" class="w-10 h-10 rounded-full object-cover"><div><p class="font-semibold text-white">${user.displayName}</p><p class="text-xs text-gray-500">${user.email}</p></div></div><button data-id="${user.id}" class="add-friend-search-btn btn-secondary text-sm" ${isFriend ? 'disabled' : ''}>${isFriend ? 'Freund' : 'Hinzufügen'}</button>`;
                    resultsContainer.appendChild(userCard);
                });
                document.querySelectorAll('.add-friend-search-btn').forEach(btn => { btn.onclick = async (e) => { const targetUserId = e.target.dataset.id; e.target.disabled = true; e.target.textContent = 'Angefragt'; await sendFriendRequest(targetUserId); }; });
            });
        };
        const sendFriendRequest = async (targetUserId) => { try { const targetUserRef = doc(db, `users/${targetUserId}`); const currentUserRef = doc(db, `users/${currentUser.uid}`); const batch = writeBatch(db); batch.update(targetUserRef, { friendRequestsReceived: arrayUnion(currentUser.uid) }); batch.update(currentUserRef, { friendRequestsSent: arrayUnion(targetUserId) }); await batch.commit(); showToast('Freundschaftsanfrage gesendet!', 'success'); } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } };
        const displayFriendRequests = async (requestUids) => {
            const container = document.getElementById('friend-requests-list'); if(!container) return;
            if (!requestUids || requestUids.length === 0) { container.innerHTML = `<p class="text-gray-500">Keine offenen Anfragen.</p>`; return; }
            container.innerHTML = '';
            for (const uid of requestUids) {
                const userDoc = await getDoc(doc(db, `users/${uid}`));
                if (userDoc.exists()) {
                    const user = userDoc.data();
                    const requestCard = document.createElement('div');
                    requestCard.className = 'glass-card p-3 flex items-center justify-between';
                    requestCard.innerHTML = `<div class="flex items-center gap-3"><img src="${user.photoURL || `https://placehold.co/40x40/1E293B/FFFFFF?text=${user.displayName.charAt(0)}`}" class="w-10 h-10 rounded-full object-cover"><p class="font-semibold text-white">${user.displayName}</p></div><div class="flex gap-2"><button data-id="${uid}" class="accept-friend-btn btn-primary text-sm">Annehmen</button><button data-id="${uid}" class="decline-friend-btn btn-secondary text-sm">Ablehnen</button></div>`;
                    container.appendChild(requestCard);
                }
            }
            document.querySelectorAll('.accept-friend-btn').forEach(btn => btn.onclick = (e) => acceptFriendRequest(e.target.dataset.id));
            document.querySelectorAll('.decline-friend-btn').forEach(btn => btn.onclick = (e) => declineFriendRequest(e.target.dataset.id));
        };
        const acceptFriendRequest = async (senderId) => { try { const batch = writeBatch(db); const currentUserRef = doc(db, `users/${currentUser.uid}`); const senderUserRef = doc(db, `users/${senderId}`); batch.update(currentUserRef, { friends: arrayUnion(senderId), friendRequestsReceived: arrayRemove(senderId) }); batch.update(senderUserRef, { friends: arrayUnion(currentUser.uid), friendRequestsSent: arrayRemove(currentUser.uid) }); await batch.commit(); showToast('Freund hinzugefügt!', 'success'); } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } };
        const declineFriendRequest = async (senderId) => { try { const batch = writeBatch(db); const currentUserRef = doc(db, `users/${currentUser.uid}`); const senderUserRef = doc(db, `users/${senderId}`); batch.update(currentUserRef, { friendRequestsReceived: arrayRemove(senderId) }); batch.update(senderUserRef, { friendRequestsSent: arrayRemove(currentUser.uid) }); await batch.commit(); showToast('Anfrage abgelehnt.', 'info'); } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } };
        const displayFriends = async (friendUids) => {
            const container = document.getElementById('friends-list'); if(!container) return;
            if (!friendUids || friendUids.length === 0) { container.innerHTML = `<p class="text-gray-500">Du hast noch keine Freunde.</p>`; return; }
            container.innerHTML = '';
            for (const uid of friendUids) {
                const userDoc = await getDoc(doc(db, `users/${uid}`));
                if (userDoc.exists()) {
                    const user = userDoc.data();
                    const friendCard = document.createElement('div');
                    friendCard.className = 'glass-card p-3 flex items-center justify-between';
                    friendCard.innerHTML = `<div class="flex items-center gap-3"><img src="${user.photoURL || `https://placehold.co/40x40/1E293B/FFFFFF?text=${user.displayName.charAt(0)}`}" class="w-10 h-10 rounded-full object-cover"><p class="font-semibold text-white">${user.displayName}</p></div>
                    <div class="flex items-center gap-2">
                        <button data-id="${user.id}" data-name="${user.displayName}" class="call-friend-btn text-green-400 hover:text-green-300"><i data-lucide="phone"></i></button>
                        <button data-id="${user.id}" data-name="${user.displayName}" class="chat-friend-btn text-blue-400 hover:text-blue-300"><i data-lucide="message-circle"></i></button>
                        <button data-id="${user.id}" class="remove-friend-btn text-red-500 hover:text-red-400"><i data-lucide="user-minus"></i></button>
                    </div>`;
                    container.appendChild(friendCard);
                }
            }
            lucide.createIcons();
            document.querySelectorAll('.remove-friend-btn').forEach(btn => btn.onclick = (e) => removeFriend(e.currentTarget.dataset.id));
            document.querySelectorAll('.chat-friend-btn').forEach(btn => btn.onclick = (e) => openDirectChat(e.currentTarget.dataset.id, e.currentTarget.dataset.name));
            document.querySelectorAll('.call-friend-btn').forEach(btn => btn.onclick = (e) => showCallingModal(e.currentTarget.dataset.name));
        };
        const removeFriend = async (friendId) => { showConfirmationModal('Bist du sicher, dass du diesen Freund entfernen möchtest?', async () => { try { const batch = writeBatch(db); const currentUserRef = doc(db, `users/${currentUser.uid}`); const friendUserRef = doc(db, `users/${friendId}`); batch.update(currentUserRef, { friends: arrayRemove(friendId) }); batch.update(friendUserRef, { friends: arrayRemove(currentUser.uid) }); await batch.commit(); showToast('Freund entfernt.', 'info'); } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } }); };
        
        const showCreateGroupModal = () => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Neue Gruppe erstellen';
            modalContent.innerHTML = `<form id="create-group-form"><input type="text" id="group-name" placeholder="Gruppenname" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-4" required><textarea id="group-desc" placeholder="Beschreibung" class="w-full p-3 bg-slate-800 border border-slate-700 rounded-lg mb-4" required></textarea></form>`;
            modalFooter.innerHTML = `<button id="submit-create-group" class="btn-primary w-full">Erstellen</button>`;
            openModal(genericModal);
            document.getElementById('submit-create-group').addEventListener('click', async () => {
                const name = document.getElementById('group-name').value;
                const description = document.getElementById('group-desc').value;
                if (!name || !description) { showToast('Bitte fülle alle Felder aus.', 'error'); return; }
                showLoader('Gruppe wird erstellt...');
                try { await addDoc(collection(db, 'groups'), { name, description, ownerId: currentUser.uid, members: [currentUser.uid], createdAt: serverTimestamp() }); showToast('Gruppe erfolgreich erstellt!', 'success'); closeModal(genericModal); } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } finally { hideLoader(); }
            });
        };

        const getChatRoomId = (uid1, uid2) => [uid1, uid2].sort().join('_');

        const openDirectChat = (friendId, friendName) => {
            const chatRoomId = getChatRoomId(currentUser.uid, friendId);
            openChat(chatRoomId, friendName, 'direct');
        };

        const openGroupChat = (groupId, groupName) => {
            openChat(groupId, groupName, 'group');
        };

        const openChat = (chatId, chatName, type) => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');

            modalTitle.textContent = chatName;
            modalContent.innerHTML = `<div id="chat-messages" class="h-96 overflow-y-auto flex flex-col-reverse p-2 space-y-2 space-y-reverse"></div>`;
            modalFooter.innerHTML = `
                <div id="typing-indicator" class="text-sm text-gray-400 h-5 italic"></div>
                <form id="chat-form" class="flex gap-2">
                    <input id="chat-input" class="flex-grow p-2 bg-slate-800 border border-slate-700 rounded-lg" placeholder="Nachricht schreiben..." autocomplete="off">
                    <button type="submit" class="btn-primary"><i data-lucide="send"></i></button>
                </form>
            `;
            lucide.createIcons();
            openModal(genericModal);
            
            const collectionPath = type === 'group' ? `groups/${chatId}/messages` : `directMessages/${chatId}/messages`;
            const chatRoomRef = doc(db, type === 'group' ? 'groups' : 'directMessages', chatId);

            const messagesContainer = document.getElementById('chat-messages');
            const messagesQuery = query(collection(db, collectionPath), orderBy('timestamp', 'desc'));
            const unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                messagesContainer.innerHTML = '';
                snapshot.forEach(doc => {
                    const msg = {id: doc.id, ...doc.data()};
                    const messageEl = document.createElement('div');
                    const isSender = msg.senderId === currentUser.uid;
                    messageEl.className = `flex flex-col ${isSender ? 'items-end' : 'items-start'}`;
                    
                    let readReceipt = '';
                    if (isSender) {
                        if (msg.readBy && msg.readBy.length > 0) {
                            readReceipt = `<i data-lucide="check-check" class="w-4 h-4 text-blue-400"></i>`; // Gelesen
                        } else {
                            readReceipt = `<i data-lucide="check" class="w-4 h-4 text-gray-500"></i>`; // Gesendet
                        }
                    }

                    messageEl.innerHTML = `
                        <div class="max-w-xs lg:max-w-md px-3 py-2 rounded-lg ${isSender ? 'bg-blue-700' : 'bg-slate-700'}">
                            ${!isSender && type === 'group' ? `<p class="text-xs font-bold text-blue-300">${msg.senderName}</p>` : ''}
                            <p class="text-white">${msg.text}</p>
                            <div class="flex items-center justify-end gap-1 mt-1">
                                <p class="text-xs text-gray-400">${new Date(msg.timestamp?.toDate()).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</p>
                                ${readReceipt}
                            </div>
                        </div>`;
                    messagesContainer.appendChild(messageEl);
                    if (!isSender && (!msg.readBy || !msg.readBy.includes(currentUser.uid))) {
                        updateDoc(doc.ref, { readBy: arrayUnion(currentUser.uid) });
                    }
                });
                lucide.createIcons();
            });

            const typingIndicator = document.getElementById('typing-indicator');
            const unsubscribeTyping = onSnapshot(chatRoomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const typingUsers = docSnap.data().typing || {};
                    const otherTypers = Object.keys(typingUsers).filter(uid => uid !== currentUser.uid && typingUsers[uid]);
                    if (otherTypers.length > 0) {
                        typingIndicator.textContent = '... schreibt';
                    } else {
                        typingIndicator.textContent = '';
                    }
                }
            });

            const chatInput = document.getElementById('chat-input');
            chatInput.addEventListener('input', () => {
                clearTimeout(typingTimeout);
                updateDoc(chatRoomRef, { [`typing.${currentUser.uid}`]: true });
                typingTimeout = setTimeout(() => {
                    updateDoc(chatRoomRef, { [`typing.${currentUser.uid}`]: false });
                }, 2000);
            });

            document.getElementById('chat-form').addEventListener('submit', async (e) => {
                e.preventDefault();
                clearTimeout(typingTimeout);
                updateDoc(chatRoomRef, { [`typing.${currentUser.uid}`]: false });
                const text = chatInput.value.trim();
                if (text) {
                    chatInput.value = '';
                    await addDoc(collection(db, collectionPath), { text, senderId: currentUser.uid, senderName: currentUserProfile.displayName, timestamp: serverTimestamp(), readBy: [] });
                }
            });

            const observer = new MutationObserver((mutations) => {
                if (genericModal.classList.contains('hidden')) {
                    unsubscribeChat();
                    unsubscribeTyping();
                    updateDoc(chatRoomRef, { [`typing.${currentUser.uid}`]: false });
                    observer.disconnect();
                }
            });
            observer.observe(genericModal, { attributes: true });
        };
        
        const showCallingModal = (friendName) => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = `Rufe ${friendName} an`;
            modalContent.innerHTML = `<div class="text-center p-8"><div class="loader mx-auto"></div><p class="mt-4">Verbinde...</p><p class="text-xs text-gray-500 mt-2">(Anruf-Funktion ist derzeit eine Simulation)</p></div>`;
            modalFooter.innerHTML = `<button id="end-call-btn" class="btn-primary bg-red-600 hover:bg-red-500 w-full">Anruf beenden</button>`;
            openModal(genericModal);
            document.getElementById('end-call-btn').onclick = () => closeModal(genericModal);
        };
        
        const showProfilePicModal = () => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Profilbild ändern';
            modalContent.innerHTML = `<div class="flex flex-col items-center"><img id="pic-preview" src="${currentUserProfile.photoURL || `https://placehold.co/128x128/1E293B/FFFFFF?text=${currentUserProfile.displayName.charAt(0)}`}" class="w-32 h-32 rounded-full object-cover mb-4 border-2 border-slate-600"><input type="file" id="pic-upload-input" class="hidden" accept="image/*"><label for="pic-upload-input" class="btn-secondary cursor-pointer">Bild auswählen</label></div>`;
            modalFooter.innerHTML = `<button id="submit-pic-upload" class="btn-primary w-full" disabled>Hochladen & Speichern</button>`;
            openModal(genericModal);
            const input = document.getElementById('pic-upload-input');
            const preview = document.getElementById('pic-preview');
            const submitBtn = document.getElementById('submit-pic-upload');
            let selectedFile = null;
            input.addEventListener('change', (e) => {
                selectedFile = e.target.files[0];
                if (selectedFile) {
                    const reader = new FileReader();
                    reader.onload = (event) => { preview.src = event.target.result; };
                    reader.readAsDataURL(selectedFile);
                    submitBtn.disabled = false;
                }
            });
            submitBtn.addEventListener('click', async () => {
                if (!selectedFile) return;
                showLoader('Bild wird hochgeladen...');
                const storageRef = ref(storage, `profilePictures/${currentUser.uid}`);
                try {
                    const snapshot = await uploadBytes(storageRef, selectedFile);
                    const downloadURL = await getDownloadURL(snapshot.ref);
                    await updateDoc(doc(db, 'users', currentUser.uid), { photoURL: downloadURL });
                    await updateProfile(auth.currentUser, { photoURL: downloadURL });
                    showToast('Profilbild erfolgreich aktualisiert!', 'success');
                    closeModal(genericModal);
                } catch (error) { console.error("Upload failed", error); showToast('Fehler beim Hochladen des Bildes.', 'error'); } finally { hideLoader(); }
            });
        };
        
        const showNotesModal = () => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Meine Notizen';
            modalContent.innerHTML = `<div id="notes-list" class="space-y-2"></div>`;
            modalFooter.innerHTML = `<form id="add-note-form" class="flex gap-2"><input id="note-input" class="flex-grow p-2 bg-slate-800 border border-slate-700 rounded-lg" placeholder="Neue Notiz..." autocomplete="off"><button type="submit" class="btn-primary"><i data-lucide="plus"></i></button></form>`;
            lucide.createIcons();
            openModal(genericModal);
            const notesCollectionRef = collection(db, `users/${currentUser.uid}/notes`);
            const q = query(notesCollectionRef, orderBy('createdAt', 'desc'));
            onSnapshot(q, (snapshot) => {
                const list = document.getElementById('notes-list');
                if (!list) return;
                list.innerHTML = '';
                if(snapshot.empty) { list.innerHTML = `<p class="text-center text-gray-500 p-4">Keine Notizen vorhanden.</p>`; return; }
                snapshot.forEach(doc => {
                    const note = { id: doc.id, ...doc.data() };
                    const noteEl = document.createElement('div');
                    noteEl.className = 'p-3 glass-card rounded-lg flex justify-between items-center';
                    noteEl.innerHTML = `<p>${note.text}</p><button data-id="${note.id}" class="delete-note-btn text-red-500 hover:text-red-400"><i data-lucide="trash-2"></i></button>`;
                    list.appendChild(noteEl);
                });
                document.querySelectorAll('.delete-note-btn').forEach(btn => { btn.onclick = (e) => { const noteId = e.currentTarget.dataset.id; deleteDoc(doc(db, `users/${currentUser.uid}/notes`, noteId)); }; });
                lucide.createIcons();
            });
            document.getElementById('add-note-form').addEventListener('submit', async (e) => { e.preventDefault(); const input = document.getElementById('note-input'); const text = input.value.trim(); if (text) { input.value = ''; await addDoc(notesCollectionRef, { text, createdAt: serverTimestamp() }); } });
        };
        
        const showAdminPanel = async () => {
            const modalTitle = document.getElementById('generic-modal-title');
            const modalContent = document.getElementById('generic-modal-content');
            const modalFooter = document.getElementById('generic-modal-footer');
            modalTitle.textContent = 'Admin Panel';
            modalContent.innerHTML = '<div class="loader"></div>';
            modalFooter.innerHTML = '';
            openModal(genericModal);
            
            const usersRef = collection(db, "users");
            onSnapshot(usersRef, (querySnapshot) => {
                let userCardsHtml = '';
                querySnapshot.forEach(doc => {
                    const user = {id: doc.id, ...doc.data()};
                    if (user.id === currentUser.uid) return;
                    
                    const crownIcon = user.role === 'founder' || user.role === 'admin' ? `<i data-lucide="crown" class="w-5 h-5 text-yellow-400"></i>` : '';
                    
                    let adminButtonHtml = '';
                    if (user.role === 'founder') {
                        adminButtonHtml = `<button class="btn-secondary text-sm flex-grow opacity-50 cursor-not-allowed" disabled>Gründer</button>`;
                    } else {
                        adminButtonHtml = `<button data-id="${user.id}" data-role="${user.role}" class="toggle-admin-btn btn-secondary text-sm flex-grow ${currentUserProfile.role !== 'founder' ? 'opacity-50 cursor-not-allowed' : ''}" ${currentUserProfile.role !== 'founder' ? 'disabled' : ''}>${user.role === 'admin' ? 'Admin entfernen' : 'Admin geben'}</button>`;
                    }

                    let banButtonHtml = '';
                    if (user.role === 'founder') {
                        banButtonHtml = `<button class="bg-slate-800 text-gray-500 font-bold py-2 px-4 rounded-lg text-sm flex-grow cursor-not-allowed" disabled>Unantastbar</button>`;
                    } else {
                        banButtonHtml = `<button data-id="${user.id}" data-banned="${user.banned}" class="toggle-ban-btn ${user.banned ? 'bg-green-600 hover:bg-green-500' : 'bg-red-600 hover:bg-red-500'} text-white font-bold py-2 px-4 rounded-lg text-sm flex-grow">${user.banned ? 'Entsperren' : 'Sperren'}</button>`;
                    }

                    userCardsHtml += `
                        <div class="glass-card p-4 rounded-lg">
                            <div class="flex justify-between items-start">
                                <div class="flex items-center gap-3">
                                    <img src="${user.photoURL || `https://placehold.co/48x48/1E293B/FFFFFF?text=${user.displayName.charAt(0)}`}" class="w-12 h-12 rounded-full object-cover">
                                    <div>
                                        <p class="font-bold text-lg flex items-center gap-2">${user.displayName} ${crownIcon}</p>
                                        <p class="text-sm text-gray-400">${user.email}</p>
                                    </div>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm text-gray-400">Bans: ${user.banCount || 0}</p>
                                    <img src="https://placehold.co/24x24/1E293B/FFFFFF?text=${user.id.slice(0,1)}" class="w-6 h-6 rounded-full inline-block mt-1" title="User ID: ${user.id}">
                                </div>
                            </div>
                            <div class="mt-4 pt-4 border-t border-slate-700 flex gap-2">
                                ${adminButtonHtml}
                                ${banButtonHtml}
                            </div>
                        </div>
                    `;
                });
                modalContent.innerHTML = `<div class="space-y-4">${userCardsHtml}</div>`;
                lucide.createIcons();
                document.querySelectorAll('.toggle-admin-btn').forEach(btn => { btn.onclick = (e) => toggleAdminRole(e.currentTarget.dataset.id, e.currentTarget.dataset.role); });
                document.querySelectorAll('.toggle-ban-btn').forEach(btn => { btn.onclick = (e) => toggleBanStatus(e.currentTarget.dataset.id, e.currentTarget.dataset.banned === 'true'); });
            });
        };
        
        const toggleAdminRole = async (userId, currentRole) => {
            if (currentUserProfile.role !== 'founder') { showToast('Nur der Gründer kann Rollen ändern.', 'error'); return; }
            const newRole = currentRole === 'admin' ? 'user' : 'admin';
            showLoader('Rolle wird aktualisiert...');
            try {
                const userRef = doc(db, `users/${userId}`);
                await updateDoc(userRef, { role: newRole });
                showToast('Benutzerrolle aktualisiert.', 'success');
            } catch (error) {
                showToast(`Fehler: ${error.message}`, 'error');
            } finally {
                hideLoader();
            }
        };

        const toggleBanStatus = async (userId, isCurrentlyBanned) => {
            const userToModifyRef = doc(db, "users", userId);
            const userToModifySnap = await getDoc(userToModifyRef);
            if (userToModifySnap.exists() && userToModifySnap.data().role === 'founder') {
                showToast("Der Gründer kann nicht gesperrt werden.", "error");
                return;
            }

            if (isCurrentlyBanned) {
                showLoader('Benutzer wird entsperrt...');
                try {
                    await updateDoc(userToModifyRef, { banned: false, bannedBy: null });
                    showToast('Benutzer wurde entsperrt.', 'success');
                } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } finally { hideLoader(); }
            } else {
                showLoader('Benutzer wird gesperrt...');
                try {
                    await updateDoc(userToModifyRef, { 
                        banned: true,
                        bannedBy: currentUser.uid,
                        banCount: increment(1)
                    });
                    showToast('Benutzer wurde gesperrt.', 'success');
                } catch (error) { showToast(`Fehler: ${error.message}`, 'error'); } finally { hideLoader(); }
            }
        };

        // --- INITIALIZATION ---
        window.onload = () => {
            lucide.createIcons();
            if (!app) return;
            updateUIForLoggedOutUser();
        };
        
        // --- Event Listeners for Modals ---
        document.getElementById('close-auth-modal').addEventListener('click', () => closeModal(authModal));
        document.getElementById('close-chats-friends-modal').addEventListener('click', () => closeModal(chatsFriendsModal));
        document.getElementById('close-generic-modal').addEventListener('click', () => closeModal(genericModal));

    </script>
</body>
</html>
